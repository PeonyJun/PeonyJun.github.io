<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peony King - 管理中心</title>
    <style>
        :root {
            --primary: #6366f1; --primary-hover: #4f46e5; --danger: #ef4444; --danger-hover: #dc2626; --success: #22c55e;
            --bg-main: #f3f4f6; --bg-content: #ffffff; --text-main: #111827; --text-secondary: #6b7280; 
            --border: #e5e7eb; --sidebar-width: 220px; --header-height: 60px;
        }
        body.dark {
            --primary: #818cf8; --primary-hover: #6366f1; --bg-main: #111827; --bg-content: #1f2937;
            --text-main: #f9fafb; --text-secondary: #9ca3af; --border: #374151;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background-color: var(--bg-main); color: var(--text-main); transition: background-color .3s, color .3s; font-size: 15px; line-height: 1.6; overflow-x: hidden; }
        body.no-scroll { overflow: hidden; }
        a { text-decoration: none; color: var(--primary); }
        ul { list-style: none; }
        .admin-panel { display: flex; }
        .sidebar { width: var(--sidebar-width); height: 100vh; background-color: var(--bg-content); position: fixed; top: 0; left: 0; transform: translateX(-100%); transition: transform .3s ease, background-color .3s; z-index: 1000; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .sidebar.open { transform: translateX(0); }
        .main-content { width: 100%; margin-left: 0; padding-top: var(--header-height); transition: margin-left .3s ease; }
        @media (min-width: 768px) { .sidebar { transform: translateX(0); } .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); } }
        .header { height: var(--header-height); background-color: var(--bg-content); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: fixed; top: 0; width: 100%; z-index: 900; transition: background-color .3s, border-color .3s; }
        .menu-toggle { display: block; cursor: pointer; } .menu-toggle .icon { stroke: var(--text-secondary); }
        @media (min-width: 768px) { .menu-toggle { display: none; } .header { width: calc(100% - var(--sidebar-width)); left: var(--sidebar-width); } }
        .header-actions { display: flex; align-items: center; gap: 12px; background-color: var(--bg-main); padding: 6px 12px; border-radius: 99px; }
        .sidebar-header { padding: 18px 24px; font-size: 1.25rem; font-weight: bold; white-space: nowrap; }
        .sidebar-nav { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .nav-item a { display: flex; align-items: center; padding: 11px 20px; border-radius: 8px; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-item a:hover { background-color: var(--primary); color: white; }
        .nav-item a.active { background-color: var(--primary); color: white; font-weight: 600; }
        .nav-item a svg { margin-right: 15px; width: 20px; height: 20px; stroke-width: 2; flex-shrink: 0; }
        .content-wrapper { padding: 20px; }
        .page-header { margin-bottom: 20px; } .page-title { font-size: 1.6rem; font-weight: 700; line-height: 1.2; } .page-subtitle { font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; }
        .content-view { display: none; } .content-view.active { display: block; animation: fadeIn .3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background-color: var(--bg-content); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all .3s; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 20px; } .card-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; background-color: color-mix(in srgb, var(--bg-main) 50%, transparent); }
        .card-title { font-size: 1.1rem; font-weight: 600; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn:disabled { background-color: var(--border); color: var(--text-secondary); cursor: not-allowed; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger); color: white; } .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-secondary { background-color: var(--bg-main); color: var(--text-main); border: 1px solid var(--border); }
        .form-group { margin-bottom: 16px; } .form-label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .form-control { width: 100%; padding: 10px 14px; background-color: var(--bg-main); border: 1px solid var(--border); border-radius: 8px; color: var(--text-main); font-size: 0.95rem; transition: all .2s; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); }
        .form-hint { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; }
        textarea.form-control { min-height: 120px; resize: vertical; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; } .switch input { display: none; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 24px; } .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--primary); } input:checked + .slider:before { transform: translateX(20px); }
        .table-responsive { width: 100%; overflow-x: auto; } .table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        .table th, .table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        .table th { font-weight: 600; color: var(--text-secondary); font-size: 13px; text-transform: uppercase; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); } .empty-state svg { width: 48px; height: 48px; margin: 0 auto 16px; }
        .action-btn { background: none; border: none; padding: 6px; border-radius: 50%; cursor: pointer; transition: background-color .2s; }
        .action-btn:hover { background-color: var(--border); } .action-btn svg { width: 18px; height: 18px; stroke: var(--text-secondary); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1100; display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; visibility: hidden; transition: all .3s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-box { background-color: var(--bg-content); border-radius: 12px; padding: 24px; width: 100%; max-width: 450px; }
        .modal-header { font-size: 1.2rem; font-weight: 600; margin-bottom: 12px; } .modal-body { color: var(--text-secondary); margin-bottom: 24px; } .modal-footer { display: flex; justify-content: flex-end; gap: 12px; }
        .grid { display: grid; gap: 16px; } .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; } @media (min-width: 768px) { #overlay { display: none !important; } }
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .tab-btn { padding: 12px 20px; border: none; background: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; position: relative; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--primary); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--bg-content); color: var(--text-main); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; transform: translateX(120%); animation: slideIn .3s ease forwards; }
        .toast.success { border-left: 4px solid var(--success); } .toast.danger { border-left: 4px solid var(--danger); }
        @keyframes slideIn { to { transform: translateX(0); } }
    </style>
</head>
<body class="dark">
    <div id="toast-container" class="toast-container"></div>
    <div class="admin-panel">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">Peony King</div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item"><a href="#" class="nav-link active" data-view="dashboard"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>仪表盘</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-view="articles"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>文章管理</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-view="wallpapers"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>壁纸管理</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-view="settings"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>网站设置</a></li>
                </ul>
            </nav>
        </aside>
        
        <div class="main-content" id="main-content">
            <header class="header">
                <div class="menu-toggle" id="menu-toggle"><svg class="icon" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></div>
                <div class="header-actions">
                    <label class="switch" title="切换主题"><input type="checkbox" id="theme-toggle" checked><span class="slider"></span></label>
                    <div>牡丹君</div>
                </div>
            </header>

            <main class="content-wrapper">
                <div id="view-dashboard" class="content-view active">
                    <div class="page-header"><h1 class="page-title">仪表盘</h1><p class="page-subtitle">欢迎回来，牡丹君！请先在“网站设置” -> “GitHub同步”中配置并加载数据。</p></div>
                    <div class="card"><div class="card-header"><h2 class="card-title">网站概览</h2></div><div class="card-body" id="dashboard-stats"><div class="empty-state"><p>暂无数据。请先从 GitHub 加载。</p></div></div></div>
                </div>

                <div id="view-articles" class="content-view">
                    <div class="page-header"><h1 class="page-title">文章管理</h1></div>
                    <div class="card"><div class="card-header"><h2 class="card-title">文章列表</h2><button class="btn btn-primary" id="new-article-btn">新建文章</button></div><div class="table-responsive"><table class="table"><thead id="articles-table-head"></thead><tbody id="articles-table-body"></tbody></table></div></div>
                </div>

                <div id="view-wallpapers" class="content-view">
                    <div class="page-header"><h1 class="page-title">壁纸管理</h1></div>
                    <div class="card"><div class="card-header"><h2 class="card-title">壁纸合集列表</h2><button class="btn btn-primary" id="new-wallpaper-btn">新建壁纸合集</button></div><div class="table-responsive"><table class="table"><thead id="wallpapers-table-head"></thead><tbody id="wallpapers-table-body"></tbody></table></div></div>
                </div>
                
                <div id="view-settings" class="content-view">
                     <div class="page-header"><h1 class="page-title">网站设置</h1><p class="page-subtitle">管理网站的全局配置和数据同步</p></div>
                    <div class="card">
                        <div class="tabs" id="settings-tabs">
                            <button class="tab-btn active" data-tab="github">GitHub同步</button>
                        </div>
                        <div class="card-body">
                            <div id="tab-github" class="tab-content active">
                                <form id="github-form">
                                    <h3 class="card-title" style="margin-bottom: 16px;">GitHub仓库配置</h3>
                                    <div class="form-group">
                                        <label for="github-owner" class="form-label">GitHub 用户名或组织名</label>
                                        <input type="text" id="github-owner" class="form-control" placeholder="例如: rjdsq" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="github-repo" class="form-label">仓库名称</label>
                                        <input type="text" id="github-repo" class="form-control" placeholder="例如: rjdsq.github.io" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="github-token" class="form-label">Personal Access Token (PAT)</label>
                                        <input type="password" id="github-token" class="form-control" required>
                                        <p class="form-hint">需要 'repo' 范围权限。此令牌仅存储在您的浏览器中，不会上传。</p>
                                    </div>
                                    <div style="display:flex; justify-content:flex-end; gap: 12px;">
                                        <button type="button" class="btn btn-secondary" id="fetch-from-github-btn">从GitHub加载数据</button>
                                        <button type="submit" class="btn btn-primary" id="save-to-github-btn" disabled>保存并同步到GitHub</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="modal-overlay" id="edit-modal"><div class="modal-box"><div class="modal-header" id="edit-modal-title"></div><div class="modal-body" id="edit-modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" id="edit-modal-cancel">取消</button><button type="submit" class="btn btn-primary" id="edit-modal-save">保存</button></div></div></div>
    <div class="modal-overlay" id="delete-modal"><div class="modal-box"><div class="modal-header">确认操作</div><div class="modal-body">您确定要删除这个项目吗？此操作不可恢复。</div><div class="modal-footer"><button class="btn btn-secondary" data-modal-close>取消</button><button class="btn btn-danger" id="confirm-delete">确认删除</button></div></div></div>
    <div id="overlay"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        let db = { articles: [], wallpapers: [] };
        let githubConfig = { owner: '', repo: '', token: '' };
        let indexFileContent = '';
        let indexFileSha = '';

        const sidebar = $('#sidebar'), menuToggle = $('#menu-toggle'), themeToggle = $('#theme-toggle'), overlay = $('#overlay');
        const deleteModal = $('#delete-modal'), editModal = $('#edit-modal');
        let activeView = 'dashboard';
        let state = { editingType: null, editingId: null };

        const showView = (viewId) => {
            $$('.content-view').forEach(v => v.classList.remove('active'));
            $(`#view-${viewId}`).classList.add('active');
            $$('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.view === viewId));
            activeView = viewId;
            if (window.innerWidth < 768) { sidebar.classList.remove('open'); overlay.style.display = 'none'; }
        };

        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            $('#toast-container').appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        };

        const renderAllTables = () => {
            renderTable('articles');
            renderTable('wallpapers');
            renderDashboard();
        };

        const renderDashboard = () => {
            const container = $('#dashboard-stats');
            if (db.articles.length === 0 && db.wallpapers.length === 0) {
                 container.innerHTML = `<div class="empty-state"><p>暂无数据。请先从 GitHub 加载。</p></div>`;
            } else {
                container.innerHTML = `<p>文章总数: ${db.articles.length}</p><p>壁纸合集数: ${db.wallpapers.length}</p>`;
            }
        };

        const createActionButtons = (type, id) => `<td style="text-align:right;"><div style="display:flex; justify-content:flex-end; gap: 8px;"><button class="action-btn edit-btn" data-type="${type}" data-id="${id}" title="编辑"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><button class="action-btn delete-btn" data-type="${type}" data-id="${id}" title="删除"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></td>`;
        
        const renderTable = (type) => {
            const headers = type === 'articles' ? ['ID', '标题', '图片URL', ''] : ['ID', '标题', '缩略图URL', '图片数', ''];
            const tableHead = $(`#${type}-table-head`), tableBody = $(`#${type}-table-body`);
            if(!tableHead || !tableBody) return;
            tableHead.innerHTML = `<tr>${headers.map(h => `<th ${h===''?'style="text-align:right"':''}>${h}</th>`).join('')}</tr>`;
            
            const data = db[type];
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${headers.length}"><div class="empty-state"><p>暂无数据。</p></div></td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(item => {
                let rowData = type === 'articles'
                    ? [item.id, item.title, item.img]
                    : [item.id, item.title, item.thumb, item.images.length];
                return `<tr>${rowData.map(td => `<td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${td}</td>`).join('')}${createActionButtons(type, item.id)}</tr>`;
            }).join('');
        };

        const openEditModal = (type, id = null) => {
            state.editingType = type;
            state.editingId = id;
            const isArticle = type === 'articles';
            const item = id ? db[type].find(i => i.id == id) : null;
            
            $('#edit-modal-title').textContent = `${id ? '编辑' : '新建'}${isArticle ? '文章' : '壁纸合集'}`;
            
            let formHtml = `<div class="form-group"><label class="form-label">ID</label><input type="text" id="edit-id" class="form-control" ${id ? 'disabled' : ''} value="${item?.id || ''}"></div>`;
            formHtml += `<div class="form-group"><label class="form-label">标题</label><input type="text" id="edit-title" class="form-control" value="${item?.title || ''}"></div>`;
            
            if (isArticle) {
                formHtml += `<div class="form-group"><label class="form-label">图片URL</label><input type="url" id="edit-img" class="form-control" value="${item?.img || ''}"></div>`;
            } else {
                formHtml += `<div class="form-group"><label class="form-label">缩略图URL</label><input type="url" id="edit-thumb" class="form-control" value="${item?.thumb || ''}"></div>`;
                formHtml += `<div class="form-group"><label class="form-label">图片列表 (每行一个URL)</label><textarea id="edit-images" class="form-control">${item?.images.join('\n') || ''}</textarea></div>`;
            }
            $('#edit-modal-body').innerHTML = formHtml;
            editModal.classList.add('open');
        };

        const saveEdit = () => {
            const { editingType, editingId } = state;
            const isArticle = editingType === 'articles';
            const idValue = isArticle ? parseInt($('#edit-id').value) : $('#edit-id').value;
            if (!idValue) { showToast('ID不能为空', 'danger'); return; }

            const newItem = {
                id: idValue,
                title: $('#edit-title').value,
                type: isArticle ? 'latest' : 'wallpaper',
            };

            if(isArticle) {
                newItem.img = $('#edit-img').value;
            } else {
                newItem.thumb = $('#edit-thumb').value;
                newItem.images = $('#edit-images').value.split('\n').filter(url => url.trim() !== '');
                newItem.date = item?.date || '2025年01月01日';
                newItem.views = item?.views || 100;
            }

            if(editingId) {
                const index = db[editingType].findIndex(i => i.id == editingId);
                db[editingType][index] = newItem;
            } else {
                if (db[editingType].some(i => i.id == newItem.id)) {
                    showToast('该ID已存在，请使用唯一的ID', 'danger'); return;
                }
                db[editingType].push(newItem);
            }
            renderTable(editingType);
            editModal.classList.remove('open');
            showToast('保存成功');
        };

        const handleApiRequest = async (url, options) => {
            const response = await fetch(url, options);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || `API请求失败: ${response.status}`);
            }
            return response.json();
        };

        const fetchFromGitHub = async () => {
            const btn = $('#fetch-from-github-btn');
            btn.textContent = '加载中...';
            btn.disabled = true;

            try {
                const url = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/index.html`;
                const options = {
                    headers: { 'Authorization': `token ${githubConfig.token}` }
                };
                const data = await handleApiRequest(url, options);

                indexFileContent = atob(data.content);
                indexFileSha = data.sha;

                const articlesMatch = indexFileContent.match(/const articlesData = (\[[\s\S]*?\])/);
                const wallpapersMatch = indexFileContent.match(/const wallpaperData = (\[[\s\S]*?\])/);

                if (!articlesMatch || !wallpapersMatch) {
                    throw new Error('无法在 index.html 中找到 articlesData 或 wallpaperData 变量。');
                }
                
                db.articles = new Function(`return ${articlesMatch[1]}`)();
                db.wallpapers = new Function(`return ${wallpapersMatch[1]}`)();

                renderAllTables();
                $('#save-to-github-btn').disabled = false;
                showToast('数据加载成功!');
            } catch (error) {
                showToast(`加载失败: ${error.message}`, 'danger');
            } finally {
                btn.textContent = '从GitHub加载数据';
                btn.disabled = false;
            }
        };

        const saveToGitHub = async () => {
            const btn = $('#save-to-github-btn');
            btn.textContent = '保存中...';
            btn.disabled = true;

            try {
                const newArticlesString = `const articlesData = ${JSON.stringify(db.articles, null, 4)}`;
                const newWallpapersString = `const wallpaperData = ${JSON.stringify(db.wallpapers, null, 4)}`;
                
                let updatedContent = indexFileContent.replace(/const articlesData = (\[[\s\S]*?\])/, newArticlesString);
                updatedContent = updatedContent.replace(/const wallpaperData = (\[[\s\S]*?\])/, newWallpapersString);

                const url = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/index.html`;
                const options = {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${githubConfig.token}` },
                    body: JSON.stringify({
                        message: `CMS: 内容更新于 ${new Date().toISOString()}`,
                        content: btoa(updatedContent),
                        sha: indexFileSha
                    })
                };

                const data = await handleApiRequest(url, options);
                indexFileSha = data.content.sha; // 更新SHA以便下次保存
                indexFileContent = updatedContent; // 更新内存中的内容
                showToast('成功保存到GitHub!');
            } catch (error) {
                showToast(`保存失败: ${error.message}`, 'danger');
            } finally {
                btn.textContent = '保存并同步到GitHub';
                btn.disabled = false;
            }
        };

        const initEventListeners = () => {
            menuToggle.addEventListener('click', () => { sidebar.classList.toggle('open'); overlay.style.display = 'block'; });
            overlay.addEventListener('click', () => { sidebar.classList.remove('open'); overlay.style.display = 'none'; });
            themeToggle.addEventListener('change', () => document.body.classList.toggle('dark', !themeToggle.checked));
            
            sidebar.addEventListener('click', e => {
                const navLink = e.target.closest('.nav-link');
                if (navLink) { e.preventDefault(); showView(navLink.dataset.view); }
            });

            $('#github-form').addEventListener('submit', e => {
                e.preventDefault();
                saveToGitHub();
            });

            $('#fetch-from-github-btn').addEventListener('click', () => {
                githubConfig.owner = $('#github-owner').value;
                githubConfig.repo = $('#github-repo').value;
                githubConfig.token = $('#github-token').value;
                if (githubConfig.owner && githubConfig.repo && githubConfig.token) {
                    localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                    fetchFromGitHub();
                } else {
                    showToast('请填写所有GitHub配置信息', 'danger');
                }
            });
            
            $('#new-article-btn').addEventListener('click', () => openEditModal('articles'));
            $('#new-wallpaper-btn').addEventListener('click', () => openEditModal('wallpapers'));
            
            main-content.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if(editBtn) openEditModal(editBtn.dataset.type, editBtn.dataset.id);
                if(deleteBtn) {
                    deleteModal.classList.add('open');
                    deleteModal.dataset.type = deleteBtn.dataset.type;
                    deleteModal.dataset.id = deleteBtn.dataset.id;
                }
            });

            $('#edit-modal-save').addEventListener('click', saveEdit);
            $('#edit-modal-cancel').addEventListener('click', () => editModal.classList.remove('open'));

            deleteModal.addEventListener('click', e => {
                const target = e.target.closest('[data-modal-close], #confirm-delete');
                if (!target) return;
                if(target.id === 'confirm-delete') {
                    const { type, id } = deleteModal.dataset; 
                    db[type] = db[type].filter(item => item.id != id);
                    renderTable(type);
                    showToast('项目已删除');
                }
                deleteModal.classList.remove('open');
            });
        };

        const loadConfig = () => {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                githubConfig = JSON.parse(savedConfig);
                $('#github-owner').value = githubConfig.owner;
                $('#github-repo').value = githubConfig.repo;
                $('#github-token').value = githubConfig.token;
            }
        };

        initEventListeners();
        loadConfig();
        showView('dashboard');
    });
    </script>
</body>
</html>