<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <title>Blog</title>
    <style>
        :root{--bg-color:#ffffff;--text-color:#333333;--accent-color:#007bff;--card-bg:#f8f9fa;--border-color:#e9ecef;--header-bg:rgba(255,255,255,0.8);--shadow:0 4px 6px rgba(0,0,0,0.1);--font-main:'-apple-system',BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;--font-mono:'SFMono-Regular',Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}html.dark{--bg-color:#1a1a1a;--text-color:#e0e0e0;--accent-color:#3391ff;--card-bg:#2c2c2c;--border-color:#444444;--header-bg:rgba(26,26,26,0.8)}body{font-family:var(--font-main);background-color:var(--bg-color);color:var(--text-color);margin:0;transition:background-color .3s,color .3s}a{color:var(--accent-color);text-decoration:none}img{max-width:100%;height:auto;border-radius:8px}.container{max-width:1100px;margin:0 auto;padding:20px}header{position:sticky;top:0;z-index:1000;background-color:var(--header-bg);backdrop-filter:saturate(180%) blur(10px);box-shadow:var(--shadow)}.nav-container{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;max-width:1100px;margin:0 auto}.logo a{font-size:1.5rem;font-weight:bold;color:var(--text-color)}.nav-menu{display:flex;gap:20px;list-style:none;margin:0;padding:0}.nav-controls{display:flex;align-items:center;gap:15px}.control-btn{background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--text-color)}#menu-toggle{display:none}@media(max-width:768px){.nav-menu{display:none;position:absolute;top:100%;left:0;width:100%;background:var(--card-bg);flex-direction:column;padding:10px;box-shadow:var(--shadow)}.nav-menu.active{display:flex}#menu-toggle{display:block}}#search-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;display:none;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}.search-box{background:var(--card-bg);padding:30px;border-radius:12px;width:90%;max-width:600px;box-shadow:var(--shadow);transform:scale(0.9);transition:transform .3s}#search-overlay.active{display:flex;opacity:1}#search-overlay.active .search-box{transform:scale(1)}#search-input{width:100%;padding:15px;font-size:1.2rem;border:2px solid var(--border-color);border-radius:8px;background:var(--bg-color);color:var(--text-color)}#search-results{margin-top:20px;max-height:60vh;overflow-y:auto}#search-results a{display:block;padding:10px;border-bottom:1px solid var(--border-color);transition:background-color .2s}#search-results a:hover{background-color:var(--bg-color)}#main-content{padding-top:30px}#post-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:25px}.post-card{background:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;transition:transform .3s,box-shadow .3s;display:flex;flex-direction:column}.post-card:hover{transform:translateY(-5px);box-shadow:0 8px 15px rgba(0,0,0,0.15)}.card-image{width:100%;height:200px;object-fit:cover}.card-content{padding:20px;display:flex;flex-direction:column;flex-grow:1}.card-title{margin:0 0 10px;font-size:1.3rem}.card-meta{font-size:0.85rem;color:#888;margin-bottom:15px}.card-excerpt{font-size:1rem;flex-grow:1;margin-bottom:15px}.card-tags{margin-top:auto}.tag{display:inline-block;background:var(--accent-color);color:#fff;padding:4px 10px;border-radius:15px;font-size:0.8rem;margin-right:5px}.post-full-content{background:var(--card-bg);padding:30px;border-radius:12px;box-shadow:var(--shadow)}.post-header h1{font-size:2.5rem;margin:0 0 15px}.post-meta{margin-bottom:30px}.post-body{font-size:1.1rem;line-height:1.8}.post-body h2,.post-body h3{border-bottom:2px solid var(--border-color);padding-bottom:10px;margin-top:2rem}.post-body code:not([class]){background:var(--border-color);padding:2px 5px;border-radius:4px;font-family:var(--font-mono)}.post-body pre{background:#2d2d2d;color:#f8f8f2;padding:20px;border-radius:8px;overflow-x:auto;position:relative}.post-body pre code{background:0 0;padding:0}.copy-code-btn{position:absolute;top:10px;right:10px;background:#555;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;opacity:0.7;transition:opacity .2s}.post-body pre:hover .copy-code-btn{opacity:1}.toc{position:fixed;right:20px;top:150px;width:220px;background:var(--card-bg);padding:15px;border-radius:8px;box-shadow:var(--shadow)}.toc h4{margin-top:0}.toc ul{list-style:none;padding-left:10px;margin:0;max-height:60vh;overflow-y:auto}.toc li a{display:block;padding:5px;border-left:2px solid transparent}.toc li a.active{border-left-color:var(--accent-color);font-weight:bold}@media(max-width:1200px){.toc{display:none}}#related-posts{margin-top:40px}#related-posts h3{text-align:center;margin-bottom:20px}#giscus-container{margin-top:40px}footer{text-align:center;padding:40px 20px;margin-top:40px;border-top:1px solid var(--border-color)}#loader{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5rem}
    </style>
</head>
<body>
    <header>
        <div class="nav-container">
            <div class="logo"><a href="#">My Blog</a></div>
            <button id="menu-toggle" class="control-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
            <ul id="main-nav" class="nav-menu">
                <li><a href="#/">首页</a></li>
                <li><a href="#/archive">归档</a></li>
                <li><a href="#/tags">标签</a></li>
                <li><a href="#/page/about">关于</a></li>
            </ul>
            <div class="nav-controls">
                <button id="search-btn" class="control-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
                <button id="theme-toggle" class="control-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button>
            </div>
        </div>
    </header>

    <main class="container" id="main-content">
        <div id="loader">Loading...</div>
    </main>
    
    <div id="search-overlay">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="搜索文章...">
            <div id="search-results"></div>
        </div>
    </div>
    
    <footer>
        <p id="footer-text"></p>
        <a id="rss-link" href="rss.xml" target="_blank">RSS Feed</a>
    </footer>

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('ServiceWorker registration successful'))
                .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
    }
    const App = {
        config: {},
        posts: [],
        pages: [],
        githubRepo: '',
        basePath: '',
        
        async init() {
            this.showLoader();
            this.setupEventListeners();
            
            const owner = window.location.hostname.split('.')[0];
            const repo = `${owner}.github.io`;
            this.githubRepo = `${owner}/${repo}`;
            this.basePath = window.location.pathname.split('/').filter(p => p && !p.endsWith('.html')).join('/');
            
            const [configData, postsData] = await Promise.all([
                this.fetchData('config.json'),
                this.fetchData('posts.json')
            ]);

            this.config = configData;
            this.posts = postsData.posts.filter(p => p.status === 'published').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            this.pages = postsData.pages || [];
            
            this.applyConfig();
            this.handleRouting();
            window.addEventListener('hashchange', this.handleRouting.bind(this));
            this.hideLoader();
        },
        
        async fetchData(file) {
            const path = this.basePath ? `${this.basePath}/${file}` : file;
            const response = await fetch(`${path}?t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Failed to fetch ${file}`);
            return response.json();
        },
        
        applyConfig() {
            document.title = this.config.site.title;
            document.querySelector('.logo a').textContent = this.config.site.title;
            document.getElementById('footer-text').textContent = `© ${new Date().getFullYear()} ${this.config.site.title}. ${this.config.site.description}`;
            
            const style = this.config.styling;
            const root = document.documentElement;
            root.style.setProperty('--accent-color', style.accentColor);
            
            if (localStorage.getItem('theme') === 'dark') {
                root.classList.add('dark');
            } else {
                root.style.setProperty('--bg-color', style.backgroundColor);
                root.style.setProperty('--text-color', style.textColor);
            }

            if(style.backgroundImageUrl) {
                document.body.style.backgroundImage = `url(${style.backgroundImageUrl})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundAttachment = 'fixed';
            }

            const customCss = this.config.advanced?.customCss;
            if (customCss) {
                const styleEl = document.createElement('style');
                styleEl.textContent = customCss;
                document.head.appendChild(styleEl);
            }
        },
        
        handleRouting() {
            const hash = window.location.hash || '#/';
            const [path, slug] = hash.substring(2).split('/');
            
            this.closeMobileMenu();

            if (path === '') {
                this.renderHome();
            } else if (path === 'post' && slug) {
                this.renderPost(slug);
            } else if (path === 'archive') {
                this.renderArchive();
            } else if (path === 'tags') {
                if(slug) this.renderTag(decodeURIComponent(slug));
                else this.renderTagsList();
            } else if (path === 'page' && slug) {
                this.renderPage(slug);
            } else {
                this.renderNotFound();
            }
        },
        
        renderHome() {
            const pinnedPost = this.posts.find(p => p.pinned);
            let postHtml = '';
            if(pinnedPost){
                 postHtml += this.createPostCard(pinnedPost, true);
            }
            this.posts.filter(p => !p.pinned).forEach(post => {
                postHtml += this.createPostCard(post);
            });
            document.getElementById('main-content').innerHTML = `<div id="post-list">${postHtml}</div>`;
            this.lazyLoadImages();
        },
        
        createPostCard(post, isPinned = false) {
            const readingTime = Math.ceil(post.content.split(' ').length / 200);
            return `
                <a href="#/post/${post.slug}" class="post-card ${isPinned ? 'pinned' : ''}">
                    ${post.coverImage ? `<img src="${post.coverImage}" alt="${post.title}" class="card-image" loading="lazy">` : ''}
                    <div class="card-content">
                        <h2 class="card-title">${post.title}</h2>
                        <div class="card-meta">
                            <span>${new Date(post.createdAt).toLocaleDateString()}</span> | 
                            <span>阅读约 ${readingTime} 分钟</span>
                        </div>
                        <p class="card-excerpt">${this.getExcerpt(post.content)}</p>
                        <div class="card-tags">${(post.tags || []).map(tag => `<span class="tag">${tag}</span>`).join(' ')}</div>
                    </div>
                </a>
            `;
        },
        
        async renderPost(slug) {
            const post = this.posts.find(p => p.slug === slug);
            if (!post) { this.renderNotFound(); return; }
            
            this.updateSeoMeta(post.title, this.getExcerpt(post.content), post.coverImage);
            
            const marked = await this.getMarked();
            const postHtml = marked.parse(post.content);
            const readingTime = Math.ceil(post.content.split(' ').length / 200);

            document.getElementById('main-content').innerHTML = `
                <article class="post-full-content">
                    <header class="post-header">
                        <h1>${post.title}</h1>
                        <div class="post-meta">
                            <span>${new Date(post.createdAt).toLocaleDateString()}</span> | 
                            <span>阅读约 ${readingTime} 分钟</span>
                        </div>
                    </header>
                    <div class="post-body">${postHtml}</div>
                </article>
                <div id="related-posts"></div>
                <div id="giscus-container"></div>
            `;
            this.setupCodeBlocks();
            this.setupToc();
            this.renderRelatedPosts(post);
            this.loadGiscus();
            this.updateViewCount(post.id);
        },

        renderPage(slug) {
            const page = this.pages.find(p => p.slug === slug);
            if (!page) { this.renderNotFound(); return; }
             this.getMarked().then(marked => {
                document.getElementById('main-content').innerHTML = `
                    <article class="post-full-content">
                         <header class="post-header"><h1>${page.title}</h1></header>
                         <div class="post-body">${marked.parse(page.content)}</div>
                    </article>`;
                this.setupCodeBlocks();
            });
        },

        renderArchive() {
            const archive = this.posts.reduce((acc, post) => {
                const year = new Date(post.createdAt).getFullYear();
                const month = new Date(post.createdAt).toLocaleString('default', { month: 'long' });
                if(!acc[year]) acc[year] = {};
                if(!acc[year][month]) acc[year][month] = [];
                acc[year][month].push(post);
                return acc;
            }, {});

            let html = '<h1>归档</h1>';
            for (const year in archive) {
                html += `<h2>${year}</h2>`;
                for (const month in archive[year]) {
                    html += `<h3>${month}</h3><ul>`;
                    archive[year][month].forEach(post => {
                        html += `<li><a href="#/post/${post.slug}">${post.title}</a> - ${new Date(post.createdAt).toLocaleDateString()}</li>`;
                    });
                    html += '</ul>';
                }
            }
            document.getElementById('main-content').innerHTML = `<div class="post-full-content">${html}</div>`;
        },

        renderTagsList() {
            const tags = this.posts.reduce((acc, post) => {
                (post.tags || []).forEach(tag => {
                    acc[tag] = (acc[tag] || 0) + 1;
                });
                return acc;
            }, {});

            let html = '<h1>标签</h1><div class="tag-cloud">';
            for(const tag in tags) {
                 html += `<a href="#/tags/${encodeURIComponent(tag)}" class="tag">${tag} (${tags[tag]})</a> `;
            }
            html += '</div>';
            document.getElementById('main-content').innerHTML = `<div class="post-full-content">${html}</div>`;
        },

        renderTag(tag) {
             const filteredPosts = this.posts.filter(p => (p.tags || []).includes(tag));
             let html = `<h1>标签: ${tag}</h1><div id="post-list">`;
             filteredPosts.forEach(post => {
                 html += this.createPostCard(post);
             });
             html += '</div>';
             document.getElementById('main-content').innerHTML = html;
        },

        renderNotFound() {
            document.getElementById('main-content').innerHTML = '<h1>404 - Not Found</h1><p>页面未找到。</p>';
        },
        
        setupEventListeners() {
            document.getElementById('theme-toggle').onclick = () => {
                const html = document.documentElement;
                html.classList.toggle('dark');
                localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
                this.applyConfig();
            };
            
            const searchOverlay = document.getElementById('search-overlay');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            
            document.getElementById('search-btn').onclick = () => searchOverlay.classList.add('active');
            searchOverlay.onclick = (e) => {
                if(e.target === searchOverlay) searchOverlay.classList.remove('active');
            };
            searchInput.onkeyup = () => {
                const query = searchInput.value.toLowerCase();
                if (query.length < 2) {
                    searchResults.innerHTML = '';
                    return;
                }
                const results = this.posts.filter(p => p.title.toLowerCase().includes(query) || p.content.toLowerCase().includes(query));
                searchResults.innerHTML = results.map(p => `<a href="#/post/${p.slug}">${p.title}</a>`).join('');
            };
            document.querySelectorAll('#search-results').forEach(el => {
                el.addEventListener('click', () => searchOverlay.classList.remove('active'));
            });

            document.getElementById('menu-toggle').onclick = () => document.getElementById('main-nav').classList.toggle('active');
        },

        getExcerpt(content, length = 100) {
            const text = content.replace(/<[^>]+>/g, '');
            return text.length > length ? text.substring(0, length) + '...' : text;
        },
        
        async getMarked() {
            if (!window.marked) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
                document.body.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
            }
            return window.marked;
        },

        setupCodeBlocks() {
            document.querySelectorAll('.post-body pre').forEach(pre => {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-code-btn';
                copyBtn.textContent = '复制';
                copyBtn.onclick = () => {
                    const code = pre.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        copyBtn.textContent = '已复制!';
                        setTimeout(() => copyBtn.textContent = '复制', 2000);
                    });
                };
                pre.appendChild(copyBtn);
            });
        },

        setupToc() {
            const postBody = document.querySelector('.post-body');
            const headings = postBody.querySelectorAll('h2, h3');
            if (headings.length < 3) return;

            const tocContainer = document.createElement('nav');
            tocContainer.className = 'toc';
            tocContainer.innerHTML = '<h4>目录</h4>';
            const tocList = document.createElement('ul');

            headings.forEach((heading, i) => {
                const id = `heading-${i}`;
                heading.id = id;
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = `#${id}`;
                link.textContent = heading.textContent;
                link.style.paddingLeft = heading.tagName === 'H3' ? '20px' : '10px';
                listItem.appendChild(link);
                tocList.appendChild(listItem);
            });
            tocContainer.appendChild(tocList);
            document.getElementById('main-content').appendChild(tocContainer);
            
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const id = entry.target.getAttribute('id');
                    const tocLink = tocContainer.querySelector(`a[href="#${id}"]`);
                    if (entry.isIntersecting) {
                        tocContainer.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                        tocLink.classList.add('active');
                    }
                });
            }, { rootMargin: "0px 0px -80% 0px" });
            headings.forEach(h => observer.observe(h));
        },

        renderRelatedPosts(currentPost) {
            if (!currentPost.tags || currentPost.tags.length === 0) return;
            const related = this.posts.filter(p => {
                return p.id !== currentPost.id && p.tags.some(tag => currentPost.tags.includes(tag));
            }).slice(0, 3);

            if(related.length === 0) return;

            let html = '<h3>相关文章</h3><div id="post-list">';
            related.forEach(post => {
                html += this.createPostCard(post);
            });
            html += '</div>';
            document.getElementById('related-posts').innerHTML = html;
        },

        loadGiscus() {
            const { repo, repoId, category, categoryId } = this.config.comments;
            if (!repo || !repoId) return;
            const script = document.createElement('script');
            script.src = 'https://giscus.app/client.js';
            script.async = true;
            script.crossOrigin = 'anonymous';
            script.setAttribute('data-repo', repo);
            script.setAttribute('data-repo-id', repoId);
            script.setAttribute('data-category', category);
            script.setAttribute('data-category-id', categoryId);
            script.setAttribute('data-mapping', 'pathname');
            script.setAttribute('data-reactions-enabled', '1');
            script.setAttribute('data-emit-metadata', '0');
            script.setAttribute('data-input-position', 'top');
            script.setAttribute('data-theme', localStorage.getItem('theme') === 'dark' ? 'dark' : 'light');
            script.setAttribute('data-lang', 'zh-CN');
            document.getElementById('giscus-container').appendChild(script);
        },

        closeMobileMenu() {
            document.getElementById('main-nav').classList.remove('active');
        },

        lazyLoadImages() {
             const images = document.querySelectorAll('img[loading="lazy"]');
             const observer = new IntersectionObserver(entries => {
                 entries.forEach(entry => {
                     if (entry.isIntersecting) {
                         const img = entry.target;
                         img.src = img.dataset.src || img.src;
                         img.removeAttribute('loading');
                         observer.unobserve(img);
                     }
                 });
             });
             images.forEach(img => observer.observe(img));
        },

        updateSeoMeta(title, description, image) {
            document.querySelector('meta[name="description"]')?.remove();
            const metaDesc = document.createElement('meta');
            metaDesc.name = 'description';
            metaDesc.content = description;
            document.head.appendChild(metaDesc);
            document.title = `${title} | ${this.config.site.title}`;
        },
        
        async updateViewCount(postId){
            try {
                const statsPath = this.basePath ? `${this.basePath}/stats.json` : 'stats.json';
                const res = await fetch(`https://api.github.com/repos/${this.githubRepo}/contents/${statsPath}`);
                if(!res.ok && res.status !== 404) return;
            } catch (e) {}
        },

        showLoader() { document.getElementById('loader').style.display = 'block'; },
        hideLoader() { document.getElementById('loader').style.display = 'none'; }
    };
    
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>