<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšå®¢ç®¡ç†åå°</title>
    <style>
:root{--primary-color:#4a90e2;--primary-hover:#357abd;--danger-color:#d0021b;--success-color:#7ed321;--bg-color:#f0f2f5;--text-color:#4a4a4a;--heading-color:#1a1a1a;--card-bg:#ffffff;--border-color:#e1e4e8;--sidebar-bg:#24292e;--sidebar-text:#e1e4e8;--sidebar-hover-bg:#3f4448;--font-sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;--shadow-sm:0 1px 2px 0 rgba(0,0,0,0.05);--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);--shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05)}body{font-family:var(--font-sans);margin:0;background-color:var(--bg-color);color:var(--text-color)}*{box-sizing:border-box}#login-view{display:flex;justify-content:center;align-items:center;height:100vh}.login-box{width:90%;max-width:400px;padding:40px;background:var(--card-bg);box-shadow:var(--shadow-lg);border-radius:12px;text-align:center}.login-box h1{color:var(--heading-color);margin-bottom:1rem}.login-box input{width:100%;padding:12px;margin-bottom:1.5rem;border:1px solid var(--border-color);border-radius:8px}.login-box button{width:100%;padding:12px;background:var(--primary-color);color:#fff;border:0;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;transition:background .2s}.login-box button:hover{background:var(--primary-hover)}#admin-view{display:none}#app-header{background:var(--card-bg);padding:0 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow-sm);position:sticky;top:0;z-index:100}#logo{font-size:1.5rem;font-weight:600;color:var(--heading-color)}#main-nav{display:flex}#main-nav a{padding:20px 16px;color:var(--text-color);font-weight:500;border-bottom:3px solid transparent;transition:border-color .2s,color .2s}#main-nav a.active,#main-nav a:hover{color:var(--primary-color);border-bottom-color:var(--primary-color)}#user-menu{display:flex;align-items:center;gap:1rem;}#user-menu button{background:none;border:none;cursor:pointer;font-weight:600;color:var(--text-color)}#mobile-menu-btn{display:none;background:none;border:none;font-size:1.5rem;cursor:pointer}@media(max-width:860px){#main-nav{display:none;position:absolute;top:100%;left:0;background:var(--card-bg);width:100%;flex-direction:column;border-top:1px solid var(--border-color);box-shadow:var(--shadow)}#main-nav.active{display:flex}#mobile-menu-btn{display:block}}#main-content{padding:24px}.view{display:none}.view.active{display:block}.card{background:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);margin-bottom:24px;padding:24px}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}.stat-card{text-align:center}.stat-card h4{color:#777;margin:0 0 10px}.stat-card p{font-size:2.5rem;font-weight:bold;margin:0;color:var(--primary-color)}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}h2{margin:0;color:var(--heading-color)}.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border:none;border-radius:8px;background:var(--primary-color);color:#fff;cursor:pointer;font-weight:600;transition:background .2s}.btn:hover{background:var(--primary-hover)}.btn-danger{background:var(--danger-color);background-color:var(--danger-color)}.btn-success{background:var(--success-color);background-color:var(--success-color)}.btn-secondary{background-color:#a0aec0}table{width:100%;border-collapse:collapse;white-space:nowrap}th,td{padding:12px 15px;text-align:left;border-bottom:1px solid var(--border-color)}th{background:#f9fafb}.status-badge{padding:4px 10px;border-radius:16px;font-size:12px;font-weight:600}.status-published{background-color:#e6fffa;color:#38a169}.status-draft{background-color:#feebc8;color:#9c4221}.status-scheduled{background-color:#ebf4ff;color:#3182ce}.form-group{margin-bottom:1.5rem}.form-group label{display:block;margin-bottom:8px;font-weight:600}input[type=text],input[type=password],input[type=color],input[type=datetime-local],textarea,select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:6px}.editor-grid{display:grid;grid-template-columns:1fr 320px;gap:24px}@media(max-width:1024px){.editor-grid{grid-template-columns:1fr}}.editor-main{display:flex;flex-direction:column}.editor-sidebar .card{position:sticky;top:88px}.media-library{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem}.media-item{position:relative;border-radius:8px;overflow:hidden;box-shadow:var(--shadow-sm)}.media-item img{width:100%;height:120px;object-fit:cover;display:block}.media-overlay{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.6);color:#fff;padding:8px;font-size:12px;text-align:center;opacity:0;transition:opacity .2s;display:flex;gap:10px;justify-content:center;align-items:center}.media-item:hover .media-overlay{opacity:1}.media-overlay button{background:rgba(0,0,0,0.5);color:white;border:none;padding:5px;cursor:pointer;border-radius:4px}.toast-container{position:fixed;top:20px;right:20px;z-index:9999}.toast{background-color:#fff;padding:15px 20px;border-radius:8px;box-shadow:var(--shadow-lg);margin-bottom:10px;opacity:0;transform:translateX(100%);animation:slideIn .5s forwards}.toast.success{border-left:4px solid var(--success-color)}.toast.error{border-left:4px solid var(--danger-color)}@keyframes slideIn{to{opacity:1;transform:translateX(0)}}
    </style>
</head>
<body>

<div id="login-view">
    <div class="login-box">
        <h1>åšå®¢ç®¡ç†</h1>
        <p>è¯·è¾“å…¥æ‚¨çš„GitHub Personal Access Tokenã€‚</p>
        <input type="password" id="token-input" placeholder="å…·å¤‡ repo æƒé™çš„Token">
        <button id="login-btn">ç™»å½•</button>
        <p id="login-message" style="color:red; margin-top: 15px;"></p>
    </div>
</div>

<div id="admin-view">
    <header id="app-header">
        <div id="logo">Admin</div>
        <nav id="main-nav">
            <a href="#" data-view="dashboard" class="active">ä»ªè¡¨ç›˜</a>
            <a href="#" data-view="posts">æ–‡ç« </a>
            <a href="#" data-view="pages">é¡µé¢</a>
            <a href="#" data-view="media">åª’ä½“åº“</a>
            <a href="#" data-view="settings">è®¾ç½®</a>
        </nav>
        <div id="user-menu">
            <a href="index.html" target="_blank" class="btn">æŸ¥çœ‹ç«™ç‚¹</a>
            <button id="logout-btn">æ³¨é”€</button>
        </div>
         <button id="mobile-menu-btn">â˜°</button>
    </header>
    <main id="main-content">
        <div id="dashboard-view" class="view active">
            <div class="stats-grid">
                <div class="card stat-card"><h4>å·²å‘å¸ƒæ–‡ç« </h4><p id="published-posts-count">0</p></div>
                <div class="card stat-card"><h4>è‰ç¨¿ç®±</h4><p id="draft-posts-count">0</p></div>
                <div class="card stat-card"><h4>åª’ä½“æ–‡ä»¶</h4><p id="media-count">0</p></div>
                <div class="card stat-card"><h4>é¡µé¢æ€»æ•°</h4><p id="pages-count">0</p></div>
            </div>
        </div>
        <div id="posts-view" class="view">
            <div class="page-header"><h2>æ–‡ç« ç®¡ç†</h2><button id="new-post-btn" class="btn">æ’°å†™æ–°æ–‡ç« </button></div>
            <div class="card"><div style="overflow-x:auto;"><table><thead><tr><th>æ ‡é¢˜</th><th>çŠ¶æ€</th><th>å‘å¸ƒæ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead><tbody id="post-list"></tbody></table></div></div>
        </div>
        <div id="pages-view" class="view">
             <div class="page-header"><h2>é¡µé¢ç®¡ç†</h2><button id="new-page-btn" class="btn">åˆ›å»ºæ–°é¡µé¢</button></div>
             <div class="card"><div style="overflow-x:auto;"><table><thead><tr><th>æ ‡é¢˜</th><th>Slug</th><th>æ“ä½œ</th></tr></thead><tbody id="page-list"></tbody></table></div></div>
        </div>
        <div id="editor-view" class="view">
            <h2 id="editor-title">æ’°å†™æ–°æ–‡ç« </h2>
            <div class="editor-grid">
                <div class="editor-main">
                    <div class="card">
                        <input type="hidden" id="post-id"><input type="hidden" id="post-type" value="post">
                        <div class="form-group"><label for="post-title">æ ‡é¢˜</label><input type="text" id="post-title"></div>
                        <div class="form-group"><label for="post-slug">URL Slug</label><input type="text" id="post-slug"></div>
                        <div class="form-group"><label for="post-content">å†…å®¹ (Markdown)</label><textarea id="post-content" rows="20"></textarea></div>
                    </div>
                </div>
                <div class="editor-sidebar">
                    <div class="card">
                        <h4>å‘å¸ƒ</h4><hr>
                        <div class="form-group"><label for="post-status">çŠ¶æ€</label><select id="post-status"><option value="draft">è‰ç¨¿</option><option value="published">å‘å¸ƒ</option><option value="scheduled">å®šæ—¶å‘å¸ƒ</option></select></div>
                        <div class="form-group" id="publish-date-group" style="display:none;"><label for="post-publish-date">å‘å¸ƒæ—¶é—´</label><input type="datetime-local" id="post-publish-date"></div>
                        <button id="save-post-btn" class="btn btn-success">ä¿å­˜</button>
                    </div>
                    <div class="card">
                        <h4>å…ƒæ•°æ®</h4><hr>
                        <div class="form-group"><label for="post-tags">æ ‡ç­¾ (é€—å·åˆ†éš”)</label><input type="text" id="post-tags"></div>
                        <div class="form-group"><label for="post-cover-image">å°é¢å›¾URL</label><input type="text" id="post-cover-image"></div>
                        <div class="form-group"><label for="post-pinned">ç½®é¡¶æ–‡ç« </label><input type="checkbox" id="post-pinned"></div>
                    </div>
                    <div class="card">
                         <h4>SEO</h4><hr>
                         <div class="form-group"><label for="post-meta-desc">Metaæè¿°</label><textarea id="post-meta-desc" rows="3"></textarea></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="media-view" class="view">
            <div class="page-header"><h2>åª’ä½“åº“</h2><input type="file" id="image-upload-input" accept="image/*" style="display:none;"><label for="image-upload-input" class="btn">ä¸Šä¼ å›¾ç‰‡</label></div>
            <div class="card"><div id="media-library" class="media-library"></div></div>
        </div>
        <div id="settings-view" class="view">
             <div class="card">
                 <h2>ç½‘ç«™è®¾ç½®</h2>
                 <div class="form-group"><label for="setting-title">ç½‘ç«™æ ‡é¢˜</label><input type="text" id="setting-title"></div>
                 <div class="form-group"><label for="setting-description">ç½‘ç«™æè¿°</label><input type="text" id="setting-description"></div>
                 <h3>å¤–è§‚</h3>
                 <div class="form-group"><label for="setting-accent-color">å¼ºè°ƒè‰²</label><input type="color" id="setting-accent-color"></div>
                 <h3>Giscusè¯„è®º</h3>
                 <div class="form-group"><label for="setting-comments-repo">ä»“åº“ (owner/repo)</label><input type="text" id="setting-comments-repo"></div>
                 <div class="form-group"><label for="setting-comments-repoid">ä»“åº“ ID</label><input type="text" id="setting-comments-repoid"></div>
                 <div class="form-group"><label for="setting-comments-category">åˆ†ç±»</label><input type="text" id="setting-comments-category"></div>
                 <div class="form-group"><label for="setting-comments-categoryid">åˆ†ç±» ID</label><input type="text" id="setting-comments-categoryid"></div>
                 <h3>é«˜çº§</h3>
                 <div class="form-group"><label for="setting-custom-css">è‡ªå®šä¹‰CSS</label><textarea id="setting-custom-css" rows="5"></textarea></div>
                 <button id="save-settings-btn" class="btn btn-success">ä¿å­˜è®¾ç½®</button>
             </div>
        </div>
    </main>
</div>
<div id="toast-container" class="toast-container"></div>

<script>
const GitHubAPI = {
    BASE_URL: 'https://api.github.com',
    async request(token, endpoint, options = {}) {
        const url = `${this.BASE_URL}${endpoint}`;
        const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', ...options.headers };
        const response = await fetch(url, { ...options, headers });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'API request failed');
        }
        if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
        return response.json();
    },
    async getFile(token, owner, repo, path) {
        try {
            const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
            return { content: atob(result.content), sha: result.sha };
        } catch (error) { if (error.message.includes('Not Found')) return null; throw error; }
    },
    updateFile: (token, owner, repo, path, content, sha, message) => GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'PUT', body: JSON.stringify({ message, content: btoa(unescape(encodeURIComponent(content))), sha }) }),
    createFile: (token, owner, repo, path, content, message, isBinary = false) => GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'PUT', body: JSON.stringify({ message, content: isBinary ? content : btoa(unescape(encodeURIComponent(content))) }) }),
    deleteFile: (token, owner, repo, path, sha, message) => GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'DELETE', body: JSON.stringify({ message, sha }) }),
    getDirectory: (token, owner, repo, path) => GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`)
};

const AdminApp = {
    token: null, owner: '', repo: '', basePath: '',
    config: {}, configSha: '', postsData: { posts: [], pages: [] }, postsSha: '',

    init() {
        this.token = localStorage.getItem('github_token');
        if (this.token) this.start();
        document.getElementById('login-btn').onclick = () => {
            const tokenInput = document.getElementById('token-input').value;
            if(tokenInput) {
                localStorage.setItem('github_token', tokenInput);
                this.token = tokenInput;
                this.start();
            }
        };
        document.getElementById('logout-btn').onclick = () => {
            localStorage.removeItem('github_token');
            window.location.reload();
        };
    },
    
    async start() {
        try {
            const user = await GitHubAPI.request(this.token, '/user');
            this.owner = user.login;
            this.repo = `${this.owner}.github.io`;
            this.basePath = window.location.pathname.split('/').filter(p => p && !p.endsWith('.html')).join('/');
            
            await this.loadData();
            
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('admin-view').style.display = 'block';

            this.setupEventListeners();
            this.updateDashboard();
            this.renderPostList();
            this.renderPageList();
        } catch (error) {
            document.getElementById('login-message').textContent = `ç™»å½•å¤±è´¥: ${error.message}`;
            localStorage.removeItem('github_token');
        }
    },

    getPath: (fileName) => AdminApp.basePath ? `${AdminApp.basePath}/${fileName}` : fileName,
    
    async loadData() {
        const [configResult, postsResult] = await Promise.all([
            GitHubAPI.getFile(this.token, this.owner, this.repo, this.getPath('config.json')),
            GitHubAPI.getFile(this.token, this.owner, this.repo, this.getPath('posts.json'))
        ]);
        
        if (configResult) {
            this.config = JSON.parse(decodeURIComponent(escape(configResult.content)));
            this.configSha = configResult.sha;
        }
        if (postsResult) {
            this.postsData = JSON.parse(decodeURIComponent(escape(postsResult.content)));
            this.postsSha = postsResult.sha;
        }
        if (!this.postsData.pages) this.postsData.pages = [];
    },
    
    showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${viewId}-view`).classList.add('active');
        document.querySelectorAll('#main-nav a').forEach(a => a.classList.toggle('active', a.dataset.view === viewId));
        const mobileNav = document.getElementById('main-nav');
        if(mobileNav.classList.contains('active')) mobileNav.classList.remove('active');
    },

    setupEventListeners() {
        document.getElementById('app-header').addEventListener('click', e => {
            const navLink = e.target.closest('a[data-view]');
            if (navLink) {
                e.preventDefault();
                this.showView(navLink.dataset.view);
                if (navLink.dataset.view === 'media') this.renderMediaLibrary();
                if (navLink.dataset.view === 'settings') this.populateSettings();
            }
            if(e.target.closest('#mobile-menu-btn')) {
                document.getElementById('main-nav').classList.toggle('active');
            }
        });

        document.getElementById('main-content').addEventListener('click', e => {
            let btn;
            if (btn = e.target.closest('#new-post-btn')) this.openEditor('post');
            else if (btn = e.target.closest('#new-page-btn')) this.openEditor('page');
            else if (btn = e.target.closest('#save-post-btn')) this.savePost();
            else if (btn = e.target.closest('#save-settings-btn')) this.saveSettings();
            else if (btn = e.target.closest('.edit-post-btn')) this.openEditor('post', btn.dataset.id);
            else if (btn = e.target.closest('.edit-page-btn')) this.openEditor('page', btn.dataset.id);
            else if (btn = e.target.closest('.copy-url-btn')) {
                 navigator.clipboard.writeText(btn.dataset.url);
                 this.showToast('URLå·²å¤åˆ¶');
            }
            else if (btn = e.target.closest('.delete-img-btn')) {
                 if(confirm('ç¡®å®šåˆ é™¤æ­¤å›¾ç‰‡å—ï¼Ÿ')) this.deleteImage(btn.dataset.path, btn.dataset.sha);
            }
        });
        
        document.getElementById('post-status').onchange = (e) => {
            document.getElementById('publish-date-group').style.display = e.target.value === 'scheduled' ? 'block' : 'none';
        };
        document.getElementById('image-upload-input').onchange = (e) => this.uploadImage(e.target.files[0]);
    },
    
    updateDashboard() {
        document.getElementById('published-posts-count').textContent = this.postsData.posts.filter(p => p.status === 'published').length;
        document.getElementById('draft-posts-count').textContent = this.postsData.posts.filter(p => p.status === 'draft').length;
        document.getElementById('pages-count').textContent = this.postsData.pages.length;
        GitHubAPI.getDirectory(this.token, this.owner, this.repo, this.getPath('images'))
            .then(files => document.getElementById('media-count').textContent = files.filter(f=>f.type==='file').length)
            .catch(() => document.getElementById('media-count').textContent = 'N/A');
    },

    renderPostList() {
        const list = document.getElementById('post-list');
        list.innerHTML = this.postsData.posts
            .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))
            .map(post => `
                <tr>
                    <td>${post.title}</td>
                    <td><span class="status-badge status-${post.status}">${post.status}</span></td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td><button class="btn btn-secondary edit-post-btn" data-id="${post.id}">ç¼–è¾‘</button></td>
                </tr>
            `).join('');
    },

    renderPageList() {
        const list = document.getElementById('page-list');
        list.innerHTML = this.postsData.pages.map(page => `
            <tr>
                <td>${page.title}</td>
                <td>/${page.slug}</td>
                <td><button class="btn btn-secondary edit-page-btn" data-id="${page.id}">ç¼–è¾‘</button></td>
            </tr>
        `).join('');
    },

    openEditor(type, id = null) {
        const isPost = type === 'post';
        const collection = isPost ? this.postsData.posts : this.postsData.pages;
        const item = collection.find(p => p.id === id);
        
        document.getElementById('editor-title').textContent = id ? `ç¼–è¾‘${isPost?'æ–‡ç« ':'é¡µé¢'}` : `åˆ›å»ºæ–°${isPost?'æ–‡ç« ':'é¡µé¢'}`;
        document.getElementById('post-id').value = item?.id || '';
        document.getElementById('post-type').value = type;
        document.getElementById('post-title').value = item?.title || '';
        document.getElementById('post-slug').value = item?.slug || '';
        document.getElementById('post-content').value = item?.content || '';

        const postOnlyElements = ['post-tags', 'post-cover-image', 'post-pinned', 'post-meta-desc', 'post-status', 'publish-date-group'];
        postOnlyElements.forEach(elId => {
            const element = document.getElementById(elId);
            const label = document.querySelector(`label[for=${elId}]`);
            const container = element.closest('.form-group') || element.parentElement;
            if (container) container.style.display = isPost ? '' : 'none';
        });

        if(isPost){
            document.getElementById('post-tags').value = item?.tags?.join(', ') || '';
            document.getElementById('post-cover-image').value = item?.coverImage || '';
            document.getElementById('post-pinned').checked = item?.pinned || false;
            document.getElementById('post-meta-desc').value = item?.metaDescription || '';
            document.getElementById('post-status').value = item?.status || 'draft';
            document.getElementById('publish-date-group').style.display = 'none';
            if (item?.status === 'scheduled' && item.publishAt) {
                document.getElementById('post-publish-date').value = item.publishAt.slice(0, 16);
                document.getElementById('publish-date-group').style.display = 'block';
            }
        }
        
        this.showView('editor');
    },

    async savePost() {
        const id = document.getElementById('post-id').value;
        const type = document.getElementById('post-type').value;
        const isPost = type === 'post';
        
        let itemData = {
            title: document.getElementById('post-title').value,
            slug: document.getElementById('post-slug').value.trim() || this.slugify(document.getElementById('post-title').value),
            content: document.getElementById('post-content').value,
            updatedAt: new Date().toISOString()
        };
        if(isPost) {
            Object.assign(itemData, {
                tags: document.getElementById('post-tags').value.split(',').map(t => t.trim()).filter(Boolean),
                coverImage: document.getElementById('post-cover-image').value.trim(),
                pinned: document.getElementById('post-pinned').checked,
                metaDescription: document.getElementById('post-meta-desc').value.trim(),
                status: document.getElementById('post-status').value
            });
            if(itemData.status === 'scheduled') {
                itemData.publishAt = new Date(document.getElementById('post-publish-date').value).toISOString();
            }
        }

        const collection = isPost ? this.postsData.posts : this.postsData.pages;
        const itemIndex = collection.findIndex(i => i.id === id);

        if(itemIndex > -1) {
            Object.assign(collection[itemIndex], itemData);
        } else {
            itemData.id = `${type}_${Date.now()}`;
            itemData.createdAt = new Date().toISOString();
            collection.push(itemData);
        }

        try {
            const message = `docs: ${id ? 'update' : 'create'} ${type} ${itemData.title}`;
            const res = await GitHubAPI.updateFile(this.token, this.owner, this.repo, this.getPath('posts.json'), JSON.stringify(this.postsData, null, 2), this.postsSha, message);
            this.postsSha = res.content.sha;
            this.showToast('ä¿å­˜æˆåŠŸ');
            if(isPost) this.renderPostList(); else this.renderPageList();
            this.updateDashboard();
            this.showView(isPost ? 'posts' : 'pages');
        } catch(error) {
            this.showToast(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
        }
    },
    
    slugify: text => text.toString().toLowerCase().trim()
        .replace(/\s+/g, '-')
        .replace(/[^\w\-]+/g, '')
        .replace(/\-\-+/g, '-'),

    async renderMediaLibrary() {
        const libraryEl = document.getElementById('media-library');
        libraryEl.innerHTML = '<p>åŠ è½½ä¸­...</p>';
        try {
            const files = await GitHubAPI.getDirectory(this.token, this.owner, this.repo, this.getPath('images'));
            libraryEl.innerHTML = files.filter(f=>f.type==='file').map(file => `
                <div class="media-item">
                    <img src="${file.download_url}" alt="${file.name}">
                    <div class="media-overlay">
                        <button class="copy-url-btn" title="å¤åˆ¶URL" data-url="${file.download_url}">ğŸ“‹</button>
                        <button class="delete-img-btn" title="åˆ é™¤å›¾ç‰‡" data-path="${file.path}" data-sha="${file.sha}">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        } catch (error) { libraryEl.innerHTML = `<p>åŠ è½½åª’ä½“åº“å¤±è´¥: ${error.message}</p>`;}
    },

    async uploadImage(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const content = e.target.result.split(',')[1];
            const path = this.getPath(`images/${Date.now()}_${file.name}`);
            try {
                await GitHubAPI.createFile(this.token, this.owner, this.repo, path, content, 'feat: upload image', true);
                this.showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                this.renderMediaLibrary();
                this.updateDashboard();
            } catch (error) { this.showToast(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error'); }
        };
        reader.readAsDataURL(file);
    },

    async deleteImage(path, sha) {
        try {
            await GitHubAPI.deleteFile(this.token, this.owner, this.repo, path, sha, 'feat: delete image');
            this.showToast('å›¾ç‰‡åˆ é™¤æˆåŠŸ');
            this.renderMediaLibrary();
            this.updateDashboard();
        } catch(error) { this.showToast(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error'); }
    },
    
    populateSettings() {
        document.getElementById('setting-title').value = this.config.site.title;
        document.getElementById('setting-description').value = this.config.site.description;
        document.getElementById('setting-accent-color').value = this.config.styling.accentColor;
        document.getElementById('setting-comments-repo').value = this.config.comments.repo;
        document.getElementById('setting-comments-repoid').value = this.config.comments.repoId;
        document.getElementById('setting-comments-category').value = this.config.comments.category;
        document.getElementById('setting-comments-categoryid').value = this.config.comments.categoryId;
        document.getElementById('setting-custom-css').value = this.config.advanced?.customCss || '';
    },

    async saveSettings() {
        const newConfig = JSON.parse(JSON.stringify(this.config));
        newConfig.site.title = document.getElementById('setting-title').value;
        newConfig.site.description = document.getElementById('setting-description').value;
        newConfig.styling.accentColor = document.getElementById('setting-accent-color').value;
        newConfig.comments.repo = document.getElementById('setting-comments-repo').value;
        newConfig.comments.repoId = document.getElementById('setting-comments-repoid').value;
        newConfig.comments.category = document.getElementById('setting-comments-category').value;
        newConfig.comments.categoryId = document.getElementById('setting-comments-categoryid').value;
        if(!newConfig.advanced) newConfig.advanced = {};
        newConfig.advanced.customCss = document.getElementById('setting-custom-css').value;

        try {
            const res = await GitHubAPI.updateFile(this.token, this.owner, this.repo, this.getPath('config.json'), JSON.stringify(newConfig, null, 2), this.configSha, 'docs: update config');
            this.configSha = res.content.sha;
            this.config = newConfig;
            this.showToast('è®¾ç½®å·²ä¿å­˜');
        } catch(error) {
            this.showToast(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
        }
    },

    showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }
};

AdminApp.init();
</script>

</body>
</html>