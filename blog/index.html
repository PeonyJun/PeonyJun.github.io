<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <title>正在加载...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style id="custom-fonts-style"></style>
    <style>
        :root{--bg-color:#f8f9fa;--text-color:#212529;--heading-color:#000;--accent-color:#007bff;--link-hover-color:#0056b3;--border-color:#dee2e6;--card-bg:#fff;--shadow-sm:0 1px 2px 0 rgba(0,0,0,.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);--font-body:'Noto Sans SC',sans-serif;--font-heading:'Montserrat',sans-serif}html.dark{--bg-color:#121212;--text-color:#adb5bd;--heading-color:#fff;--accent-color:#4dabf7;--link-hover-color:#74c0fc;--border-color:#343a40;--card-bg:#1e1e1e}body{font-family:var(--font-body);margin:0;padding:0;background-color:var(--bg-color);color:var(--text-color);line-height:1.7;transition:background-color .3s,color .3s;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.container{max-width:1100px;margin:0 auto;padding:2rem 1.5rem;display:grid;grid-template-columns:1fr;gap:2.5rem}@media(min-width: 992px){.container{grid-template-columns:1fr 300px}}.main-content{min-width:0}.sidebar{min-width:0}.site-header{background-color:var(--card-bg);padding:2rem;text-align:center;border-radius:8px;margin-bottom:2.5rem;box-shadow:var(--shadow-sm)}.site-title{font-family:var(--font-heading);font-size:2.5rem;margin:0 0 .5rem;color:var(--heading-color)}.site-description{font-size:1rem;color:var(--text-color);margin:0;white-space:pre-wrap}.posts-list.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}.posts-list.list .post-card{margin-bottom:1.5rem}.post-card{background-color:var(--card-bg);border-radius:8px;box-shadow:var(--shadow-md);overflow:hidden;transition:transform .2s,box-shadow .2s;display:flex;flex-direction:column}.post-card:hover{transform:translateY(-5px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}.post-card-image{width:100%;height:200px;object-fit:cover;border-bottom:1px solid var(--border-color)}.post-card-content{padding:1.5rem;flex-grow:1;display:flex;flex-direction:column}.post-card-title{font-family:var(--font-heading);font-size:1.3rem;margin:0 0 .75rem}.post-card-title a{color:var(--heading-color);text-decoration:none}.post-card-meta{font-size:.8rem;color:var(--text-color);opacity:.7;margin-bottom:1rem}.post-card-summary{font-size:.95rem;flex-grow:1;margin-bottom:1.5rem}.post-card-footer{margin-top:auto}.read-more-btn{font-family:var(--font-heading);font-weight:600;font-size:.85rem;color:var(--accent-color);text-decoration:none}.sidebar-widget{background-color:var(--card-bg);padding:1.5rem;border-radius:8px;box-shadow:var(--shadow-sm);margin-bottom:2rem}.widget-title{font-family:var(--font-heading);font-size:1.1rem;margin:0 0 1rem;padding-bottom:.5rem;border-bottom:2px solid var(--accent-color);color:var(--heading-color)}.widget-content.about p{margin:0;font-size:.9rem;white-space:pre-wrap}.tag-cloud{display:flex;flex-wrap:wrap;gap:.5rem}.tag-cloud a{background-color:var(--bg-color);padding:.25rem .75rem;border-radius:15px;font-size:.8rem;color:var(--text-color);text-decoration:none;transition:background-color .2s,color .2s}.tag-cloud a:hover{background-color:var(--accent-color);color:#fff}.recent-posts ul{list-style:none;padding:0;margin:0}.recent-posts li a{display:block;padding:.5rem 0;border-bottom:1px solid var(--border-color);font-size:.9rem;color:var(--text-color);text-decoration:none;transition:color .2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.recent-posts li:last-child a{border-bottom:0}.recent-posts li a:hover{color:var(--accent-color)}.post-full{background-color:var(--card-bg);border-radius:8px;box-shadow:var(--shadow-md);padding:2rem}@media(min-width: 768px){.post-full{padding:3rem}}.post-full-header{text-align:center;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:1px solid var(--border-color)}.post-full-title{font-family:var(--font-heading);font-size:2.8rem;margin:0 0 1rem;line-height:1.2;color:var(--heading-color)}.post-full-meta{font-size:.9rem;color:var(--text-color);opacity:.7}.post-full-content{font-size:1.05rem;word-wrap:break-word}.post-full-content>:first-child{margin-top:0}.post-full-content img{max-width:100%;height:auto;border-radius:8px;margin:1.5rem 0}.post-full-content a{color:var(--accent-color);text-decoration:underline}.post-full-content h2,.post-full-content h3{font-family:var(--font-heading);color:var(--heading-color);margin:2.5rem 0 1rem}.post-full-content blockquote{border-left:4px solid var(--accent-color);margin:1.5rem 0;padding:0 1.5rem;color:var(--text-color);opacity:.8}.post-full-content pre{border-radius:8px;font-size:.9rem}.site-footer{text-align:center;padding:2rem 0;margin-top:1rem;border-top:1px solid var(--border-color);color:var(--text-color);opacity:.7;font-size:.9rem}.back-to-home{display:inline-block;margin-top:3rem;font-family:var(--font-heading)}.theme-toggle{position:fixed;bottom:20px;right:20px;width:40px;height:40px;border-radius:50%;background-color:var(--card-bg);border:1px solid var(--border-color);cursor:pointer;display:flex;justify-content:center;align-items:center;font-size:1rem;box-shadow:var(--shadow-md);z-index:100}#reading-progress-bar{position:fixed;top:0;left:0;height:4px;background-color:var(--accent-color);width:0;z-index:9999;transition:width .1s}#giscus-container{margin-top:3rem}
    </style>
    <style id="custom-css-style"></style>
</head>
<body>
    <div id="reading-progress-bar"></div>
    <div class="container" style="opacity:0; transition: opacity .5s;">
        <main class="main-content" id="main-content"></main>
        <aside class="sidebar" id="sidebar"></aside>
    </div>
    <footer class="site-footer">
        <p id="footer-text"></p>
    </footer>
    <button id="theme-toggle" title="切换主题"><i class="fa-solid fa-moon"></i></button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        const b64_to_utf8 = (str) => { try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); } };

        document.addEventListener('DOMContentLoaded', async () => {
            const mainContent = document.getElementById('main-content');
            const sidebar = document.getElementById('sidebar');
            const footerText = document.getElementById('footer-text');
            const themeToggle = document.getElementById('theme-toggle');

            let allPosts = [];
            let siteConfig = {};

            const applyTheme = (theme, isInitial = false) => {
                const doc = document.documentElement;
                if (theme === 'dark') {
                    doc.classList.add('dark');
                    themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
                } else {
                    doc.classList.remove('dark');
                    themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
                }
                if (!isInitial) localStorage.setItem('theme', theme);
                const giscusFrame = document.querySelector('iframe.giscus-frame');
                if (giscusFrame) { giscusFrame.contentWindow.postMessage({ giscus: { setConfig: { theme: theme === 'dark' ? 'dark' : 'light' } } }, 'https://giscus.app'); }
            };

            const sanitizeContent = (html) => html.replace(/<\/script>/gi, '<\\/script>');

            const getFileFromApi = async (owner, repo, path) => {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) throw new Error(`无法从API获取文件: ${path}`);
                return JSON.parse(b64_to_utf8((await response.json()).content));
            };

            const renderHomePage = () => {
                const layout = siteConfig.customization?.postLayout || 'grid';
                const headerHtml = `<header class="site-header"><h1 class="site-title">${siteConfig.site.title}</h1><p class="site-description">${siteConfig.site.description}</p></header>`;
                const postsHtml = allPosts.map(post => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = sanitizeContent(post.content);
                    const summary = (tempDiv.textContent || "").substring(0, 100) + '...';
                    const firstImage = tempDiv.querySelector('img');
                    return `<div class="post-card">${firstImage ? `<img src="${firstImage.src}" alt="${post.title}" class="post-card-image">` : ''}<div class="post-card-content"><h2 class="post-card-title"><a href="#/post/${post.id}">${post.title}</a></h2><p class="post-card-meta">发布于 ${new Date(post.createdAt).toLocaleDateString()}</p><p class="post-card-summary">${summary}</p><div class="post-card-footer"><a href="#/post/${post.id}" class="read-more-btn">阅读全文 &rarr;</a></div></div></div>`;
                }).join('');
                mainContent.innerHTML = `${headerHtml}<div class="posts-list ${layout}">${postsHtml}</div>`;
            };

            const renderSinglePost = (postId) => {
                const post = allPosts.find(p => p.id === postId);
                if (!post) { mainContent.innerHTML = '<h1>404 - 文章未找到</h1>'; return; }
                document.title = `${post.title} - ${siteConfig.site.title}`;
                const finalContent = sanitizeContent(post.content.replace('<!--more-->', ''));
                mainContent.innerHTML = `
                    <article class="post-full">
                        <header class="post-full-header">
                            <h1 class="post-full-title">${post.title}</h1>
                            <p class="post-full-meta">发布于 ${new Date(post.createdAt).toLocaleDateString()} ${post.tags && post.tags.length > 0 ? `| 标签: ${post.tags.join(', ')}` : ''}</p>
                        </header>
                        <section class="post-full-content">${finalContent}</section>
                        <a href="#" class="back-to-home">&larr; 返回首页</a>
                        <div id="giscus-container"></div>
                    </article>`;
                setTimeout(() => Prism.highlightAll(), 0);
                loadGiscus();
            };

            const renderSidebar = () => {
                const tags = [...new Set(allPosts.flatMap(p => p.tags || []))];
                const recentPosts = allPosts.slice(0, 5);
                sidebar.innerHTML = `
                    <div class="sidebar-widget"><h3 class="widget-title">关于我</h3><div class="widget-content about"><p>${siteConfig.site.description}</p></div></div>
                    <div class="sidebar-widget"><h3 class="widget-title">标签</h3><div class="widget-content tag-cloud">${tags.map(tag => `<a href="#">${tag}</a>`).join('')}</div></div>
                    <div class="sidebar-widget"><h3 class="widget-title">最新文章</h3><div class="widget-content recent-posts"><ul>${recentPosts.map(p => `<li><a href="#/post/${p.id}">${p.title}</a></li>`).join('')}</ul></div></div>`;
            };

            const loadGiscus = () => {
                const { comments } = siteConfig;
                if (!comments?.repo || !comments?.repoId) return;
                const container = document.getElementById('giscus-container');
                if (!container || container.firstChild) return;
                const script = document.createElement('script');
                Object.entries({
                    src: 'https://giscus.app/client.js', 'data-repo': comments.repo, 'data-repo-id': comments.repoId, 'data-category': comments.category, 'data-category-id': comments.categoryId,
                    'data-mapping': 'pathname', 'data-strict': '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-input-position': 'top',
                    'data-theme': localStorage.getItem('theme') === 'dark' ? 'dark' : 'light', 'data-lang': 'zh-CN', crossorigin: 'anonymous', async: true
                }).forEach(([key, value]) => script.setAttribute(key, value));
                container.appendChild(script);
            };

            const handleRoute = () => {
                const hash = window.location.hash;
                if (hash.startsWith('#/post/')) {
                    const postId = hash.substring(7);
                    renderSinglePost(postId);
                } else {
                    document.title = siteConfig.site.title;
                    renderHomePage();
                }
                window.scrollTo(0, 0);
            };

            const updateReadingProgress = () => {
                const bar = document.getElementById('reading-progress-bar');
                const scrollable = document.documentElement.scrollHeight - window.innerHeight;
                bar.style.width = `${(window.scrollY / scrollable) * 100}%`;
            };

            const main = async () => {
                try {
                    const owner = window.location.hostname.split('.')[0];
                    const repo = `${owner}.github.io`;
                    const basePath = window.location.pathname.split('/').filter(p => p && p.toLowerCase() !== 'index.html').join('/');
                    const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

                    [siteConfig, allPosts] = await Promise.all([
                        getFileFromApi(owner, repo, getPath('config.json')),
                        getFileFromApi(owner, repo, getPath('posts.json'))
                    ]);
                    
                    allPosts = allPosts.filter(p => p.status === 'published').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    const { customization } = siteConfig;
                    const fontBody = customization?.fontBody || 'Noto Sans SC';
                    const fontHeading = customization?.fontHeading || 'Montserrat';
                    const fontStyle = `@import url('https://fonts.googleapis.com/css2?family=${fontBody.replace(/ /g, '+')}:wght@400;700&family=${fontHeading.replace(/ /g, '+')}:wght@700&display=swap');`;
                    document.getElementById('custom-fonts-style').innerHTML = fontStyle;
                    document.documentElement.style.setProperty('--font-body', `'${fontBody}', sans-serif`);
                    document.documentElement.style.setProperty('--font-heading', `'${fontHeading}', sans-serif`);
                    if(customization?.customCSS) document.getElementById('custom-css-style').innerHTML = customization.customCSS;

                    footerText.textContent = customization?.footerText || `© ${new Date().getFullYear()} ${siteConfig.site.title}`;
                    
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    applyTheme(savedTheme, true);

                    handleRoute();
                    renderSidebar();
                    
                    window.addEventListener('hashchange', handleRoute);
                    window.addEventListener('scroll', updateReadingProgress);
                    themeToggle.addEventListener('click', () => applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));
                    if(customization?.customJS) { const customScript = document.createElement('script'); customScript.innerHTML = customization.customJS; document.body.appendChild(customScript); }
                    document.querySelector('.container').style.opacity = 1;
                } catch (error) {
                    mainContent.innerHTML = `<h1>博客加载失败</h1><p>${error.message}</p>`;
                    document.querySelector('.container').style.opacity = 1;
                }
            };

            main();
        });
    </script>
</body>
</html>