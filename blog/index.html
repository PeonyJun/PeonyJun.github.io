<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <title>正在加载...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style id="custom-fonts-style"></style>
    <style>
        :root{--bg-color:#f4f5f5;--card-bg:#fff;--text-color:#555;--heading-color:#333;--accent-color:#00aeff;--border-color:#eee;--header-bg:rgba(255,255,255,0.85);--footer-bg:#222;--footer-text:#888;--shadow:0 1px 3px rgba(0,0,0,0.03);--font-body:'Noto Sans SC',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;--font-heading:'Noto Sans SC',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}html.dark{--bg-color:#1c1c1e;--card-bg:#2a2a2c;--text-color:#a8a8a8;--heading-color:#f2f2f2;--accent-color:#00aeff;--border-color:#3a3a3c;--header-bg:rgba(28,28,30,0.8);--footer-bg:#222;--footer-text:#777}*,:after,:before{box-sizing:border-box}body{font-family:var(--font-body);margin:0;padding-top:60px;background-color:var(--bg-color);color:var(--text-color);font-size:15px;line-height:1.8;transition:background-color .3s,color .3s;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}img{max-width:100%;height:auto;vertical-align:middle}a{color:var(--accent-color);text-decoration:none;transition:color .2s}a:hover{color:var(--heading-color)}.container{max-width:900px;margin:0 auto;padding:0 1rem}.content-wrap{background-color:var(--card-bg);padding:0 1.5rem;box-shadow:var(--shadow)}.site-header{position:fixed;top:0;left:0;right:0;height:60px;background-color:var(--header-bg);backdrop-filter:saturate(180%) blur(5px);-webkit-backdrop-filter:saturate(180%) blur(5px);z-index:1000;border-bottom:1px solid transparent;transition:all .3s ease-in-out}.site-header.scrolled{background-color:var(--card-bg);border-bottom-color:var(--border-color);box-shadow:0 2px 5px rgba(0,0,0,0.05)}.nav-container{max-width:1200px;height:100%;margin:0 auto;padding:0 1.5rem;display:flex;justify-content:space-between;align-items:center}.site-logo a{font-family:var(--font-heading);font-weight:700;font-size:1.5rem;color:var(--heading-color)}.nav-menu{display:flex;align-items:center;gap:1.5rem}.nav-menu button{background:0 0;border:0;color:var(--text-color);cursor:pointer;font-size:1.2rem;padding:0}.hero-section{height:40vh;position:relative;background-size:cover;background-position:center;color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:1rem;margin-bottom:1.5rem}.hero-section:before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4)}.hero-content{position:relative;z-index:2}.hero-tag{background:rgba(0,0,0,0.5);padding:.25rem .75rem;border-radius:3px;font-size:.9rem;margin-bottom:1rem;display:inline-block}.hero-title{font-size:2.5rem;font-weight:700;margin:0;line-height:1.2;text-shadow:0 2px 4px rgba(0,0,0,0.5)}.excerpt-link{display:block;color:inherit;text-decoration:none}.excerpt{display:flex;flex-direction:column;padding:1.5rem 0;border-bottom:1px solid var(--border-color);transition:background-color .2s ease}@media(min-width: 768px){.excerpt{flex-direction:row}}.excerpt-link:hover .excerpt-image{transform:scale(1.05)}.excerpt-image-wrap{flex-shrink:0;width:100%;margin-bottom:1rem;overflow:hidden}@media(min-width: 768px){.excerpt-image-wrap{width:220px;height:150px;margin-bottom:0;margin-right:1.5rem}}.excerpt-image{width:100%;height:100%;object-fit:cover;transition:transform .5s ease;border-radius:4px}.excerpt-body{display:flex;flex-direction:column;flex-grow:1}.excerpt-title{font-family:var(--font-heading);font-size:1.4rem;font-weight:700;color:var(--heading-color);margin:0 0 .75rem;line-height:1.3}.excerpt-meta{font-size:.85rem;color:var(--text-color);opacity:.7;display:flex;flex-wrap:wrap;align-items:center;gap:1rem;margin-bottom:.75rem}.excerpt-meta span{display:inline-flex;align-items:center;gap:.3rem}.excerpt-note{font-size:.95rem;color:var(--text-color);margin:0;flex-grow:1;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.load-more-wrap{padding:2rem 0;text-align:center}.load-more-btn{background-color:var(--accent-color);color:#fff;border:0;padding:.8rem 2rem;border-radius:5px;font-size:1rem;cursor:pointer;transition:background-color .2s}.load-more-btn:hover{background-color:var(--heading-color)}.post-full{background-color:var(--card-bg);padding:1.5rem}@media(min-width: 768px){.post-full{padding:3rem}}.post-full-title{font-family:var(--font-heading);font-size:2.5rem;font-weight:700;text-align:center;margin:0 auto 1rem;max-width:800px;line-height:1.2;color:var(--heading-color)}@media(min-width: 768px){.post-full-title{font-size:3rem}}.post-full-meta{text-align:center;color:var(--text-color);opacity:.7;margin-bottom:3rem}.post-full-content{max-width:700px;margin:0 auto;font-size:1.1rem}.post-full-content h2,.post-full-content h3{font-family:var(--font-heading);color:var(--heading-color);margin:2.5rem 0 1rem}.post-full-content p{margin-bottom:1.5rem}.post-full-content blockquote{border-left:3px solid var(--accent-color);margin:1.5rem 0;padding:0 1.5rem;color:var(--text-color);opacity:.8;font-style:italic}.post-full-content pre{border-radius:8px}.post-navigation{display:flex;justify-content:space-between;max-width:700px;margin:2rem auto 0;padding-top:2rem;border-top:1px solid var(--border-color)}.post-nav-item{display:block;max-width:48%}.post-nav-item span{display:block;font-size:.8rem;opacity:.7;margin-bottom:.25rem}.post-nav-item a{font-weight:700;color:var(--text-color)}.site-footer{background-color:var(--footer-bg);color:var(--footer-text);text-align:center;padding:2rem 1rem;margin-top:2rem;font-size:.9rem}#back-to-top{position:fixed;bottom:20px;right:20px;width:40px;height:40px;border-radius:3px;background-color:var(--heading-color);color:var(--card-bg);cursor:pointer;display:flex;justify-content:center;align-items:center;font-size:1rem;z-index:100;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s,transform .3s}#back-to-top:hover{transform:translateY(-3px)}#back-to-top.visible{opacity:1;visibility:visible}#giscus-container{max-width:700px;margin:3rem auto 0}
    </style>
    <style id="custom-css-style"></style>
</head>
<body>
    <header class="site-header" id="site-header">
        <div class="nav-container">
            <div class="site-logo">
                <a href="#" id="site-title-link"></a>
            </div>
            <nav class="nav-menu">
                <button id="theme-toggle" title="切换主题"><i class="fa-solid fa-moon"></i></button>
            </nav>
        </div>
    </header>

    <main id="main-container" style="opacity:0; transition: opacity .5s;">
        <div id="hero-section"></div>
        <div class="container">
            <div class="content-wrap">
                <div id="posts-list-view"></div>
                <div id="post-detail-view" style="display:none;"></div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <p id="footer-text"></p>
    </footer>

    <button id="back-to-top" title="返回顶部"><i class="fa-solid fa-arrow-up"></i></button>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        const b64_to_utf8 = (str) => { try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); } };

        document.addEventListener('DOMContentLoaded', async () => {
            const mainContainer = document.getElementById('main-container');
            const heroSection = document.getElementById('hero-section');
            const postListView = document.getElementById('posts-list-view');
            const postDetailView = document.getElementById('post-detail-view');
            const siteTitleLink = document.getElementById('site-title-link');
            const footerText = document.getElementById('footer-text');
            const themeToggle = document.getElementById('theme-toggle');
            const backToTopBtn = document.getElementById('back-to-top');
            const siteHeader = document.getElementById('site-header');

            let allPosts = [];
            let siteConfig = {};
            let ownerName = '';
            const postsPerPage = 5;
            let postsToShow = postsPerPage;

            const applyTheme = (theme, isInitial = false) => {
                const doc = document.documentElement;
                if (theme === 'dark') doc.classList.add('dark'); else doc.classList.remove('dark');
                themeToggle.innerHTML = `<i class="fa-solid fa-${theme === 'dark' ? 'sun' : 'moon'}"></i>`;
                if (!isInitial) localStorage.setItem('theme', theme);
                const giscusFrame = document.querySelector('iframe.giscus-frame');
                if (giscusFrame) giscusFrame.contentWindow.postMessage({ giscus: { setConfig: { theme: theme === 'dark' ? 'dark_dimmed' : 'light' } } }, 'https://giscus.app');
            };

            const sanitizeContent = (html) => html.replace(/<\/script>/gi, '<\\/script>');

            const getFileFromApi = async (owner, repo, path) => {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) throw new Error(`无法从API获取文件: ${path}`);
                return JSON.parse(b64_to_utf8((await response.json()).content));
            };
            
            const renderPosts = (start, end) => {
                const postsToRender = allPosts.slice(start, end);
                const postsHtml = postsToRender.map(post => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = sanitizeContent(post.content);
                    const summary = (tempDiv.textContent || "").substring(0, 100) + '...';
                    const firstImage = tempDiv.querySelector('img');
                    const firstTag = post.tags && post.tags.length > 0 ? post.tags[0] : '';
                    return `<a href="#/post/${post.id}" class="excerpt-link"><article class="excerpt"><div class="excerpt-image-wrap">${firstImage ? `<img src="${firstImage.src}" alt="${post.title}" class="excerpt-image">` : ''}</div><div class="excerpt-body"><h2 class="excerpt-title">${post.title}</h2><div class="excerpt-meta"><span><i class="fa-solid fa-list"></i> ${firstTag || '未分类'}</span><span><i class="fa-regular fa-clock"></i> ${new Date(post.createdAt).toLocaleDateString()}</span></div><p class="excerpt-note">${summary}</p></div></article></a>`;
                }).join('');
                
                const currentHtml = postListView.querySelector('.posts-wrapper')?.innerHTML || '';
                postListView.innerHTML = `<div class="posts-wrapper">${currentHtml + postsHtml}</div>`;

                let loadMoreBtn = document.getElementById('load-more-btn');
                if (end >= allPosts.length) {
                    if(loadMoreBtn) loadMoreBtn.remove();
                } else if (!loadMoreBtn) {
                    postListView.insertAdjacentHTML('beforeend', `<div class="load-more-wrap"><button id="load-more-btn" class="load-more-btn">加载更多</button></div>`);
                    document.getElementById('load-more-btn').addEventListener('click', loadMorePosts);
                }
            };
            
            const loadMorePosts = () => {
                const currentCount = postListView.querySelectorAll('.excerpt').length;
                renderPosts(currentCount, currentCount + postsPerPage);
            };

            const renderHomePage = () => {
                postDetailView.style.display = 'none';
                postListView.style.display = 'block';
                heroSection.style.display = 'flex';
                postListView.innerHTML = '';
                
                const firstPost = allPosts[0];
                if (firstPost) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = sanitizeContent(firstPost.content);
                    const heroImage = tempDiv.querySelector('img');
                    const heroTag = firstPost.tags && firstPost.tags.length > 0 ? firstPost.tags[0] : '';
                    heroSection.style.backgroundImage = `url(${heroImage ? heroImage.src : ''})`;
                    heroSection.innerHTML = `<div class="hero-content">${heroTag ? `<span class="hero-tag">${heroTag}</span>`: ''}<h1 class="hero-title">${firstPost.title}</h1></div>`;
                }
                
                renderPosts(1, postsPerPage + 1);
            };

            const renderSinglePost = (postId) => {
                const allPostsWithHero = [allPosts[0], ...allPosts.slice(1)];
                const currentIndex = allPostsWithHero.findIndex(p => p.id === postId);
                if (currentIndex === -1) { postListView.innerHTML = '<h1>404 - 文章未找到</h1>'; return; }
                const post = allPostsWithHero[currentIndex];
                const prevPost = allPostsWithHero[currentIndex + 1];
                const nextPost = allPostsWithHero[currentIndex - 1];

                document.title = `${post.title} - ${siteConfig.site.title}`;
                const finalContent = sanitizeContent(post.content.replace('<!--more-->', ''));
                heroSection.style.display = 'none';
                postListView.style.display = 'none';
                postDetailView.style.display = 'block';
                postDetailView.innerHTML = `<article class="post-full"><header class="post-full-header"><h1 class="post-full-title">${post.title}</h1><div class="post-full-meta"><span><i class="fa-solid fa-list"></i> ${post.tags && post.tags.length > 0 ? post.tags[0] : '未分类'}</span> &nbsp;&bull;&nbsp; <span><i class="fa-regular fa-clock"></i> ${new Date(post.createdAt).toLocaleDateString()}</span></div></header><section class="post-full-content">${finalContent}</section><div class="post-navigation"><div class="post-nav-item prev">${prevPost ? `<span>上一篇</span><a href="#/post/${prevPost.id}">${prevPost.title}</a>` : ''}</div><div class="post-nav-item next" style="text-align:right;">${nextPost ? `<span>下一篇</span><a href="#/post/${nextPost.id}">${nextPost.title}</a>` : ''}</div></div><div id="giscus-container"></div></article>`;
                setTimeout(() => Prism.highlightAll(), 0);
                loadGiscus();
            };
            
            const loadGiscus = () => {
                const { comments } = siteConfig;
                if (!comments?.repo || !comments?.repoId) return;
                const container = document.getElementById('giscus-container');
                if (!container) return;
                container.innerHTML = "";
                const script = document.createElement('script');
                Object.entries({ src: 'https://giscus.app/client.js', 'data-repo': comments.repo, 'data-repo-id': comments.repoId, 'data-category': comments.category, 'data-category-id': comments.categoryId, 'data-mapping': 'pathname', 'data-strict': '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-input-position': 'top', 'data-theme': localStorage.getItem('theme') === 'dark' ? 'dark_dimmed' : 'light', 'data-lang': 'zh-CN', crossorigin: 'anonymous', async: true }).forEach(([key, value]) => script.setAttribute(key, value));
                container.appendChild(script);
            };

            const handleRoute = () => {
                const hash = window.location.hash;
                if (hash.startsWith('#/post/')) {
                    const postId = hash.substring(7);
                    renderSinglePost(postId);
                } else {
                    document.title = siteConfig.site.title;
                    renderHomePage();
                }
                window.scrollTo(0, 0);
            };
            
            const main = async () => {
                try {
                    ownerName = window.location.hostname.split('.')[0];
                    const repo = `${ownerName}.github.io`;
                    const basePath = window.location.pathname.split('/').filter(p => p && p.toLowerCase() !== 'index.html').join('/');
                    const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

                    [siteConfig, allPosts] = await Promise.all([ getFileFromApi(ownerName, repo, getPath('config.json')), getFileFromApi(ownerName, repo, getPath('posts.json')) ]);
                    allPosts = allPosts.filter(p => p.status === 'published').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    const { customization } = siteConfig;
                    const fontBody = customization?.fontBody || 'Noto Sans SC'; const fontHeading = customization?.fontHeading || 'Noto Sans SC';
                    const fontStyle = `@import url('https://fonts.googleapis.com/css2?family=${fontBody.replace(/ /g, '+')}:wght@400;700&family=${fontHeading.replace(/ /g, '+')}:wght@700&display=swap');`;
                    document.getElementById('custom-fonts-style').innerHTML = fontStyle;
                    document.documentElement.style.setProperty('--font-body', `'${fontBody}', sans-serif`);
                    document.documentElement.style.setProperty('--font-heading', `'${fontHeading}', sans-serif`);
                    if(customization?.customCSS) document.getElementById('custom-css-style').innerHTML += customization.customCSS;
                    
                    siteTitleLink.textContent = siteConfig.site.title;
                    footerText.textContent = customization?.footerText || `© ${new Date().getFullYear()} ${siteConfig.site.title}`;
                    
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    applyTheme(savedTheme, true);

                    handleRoute();
                    
                    window.addEventListener('hashchange', handleRoute);
                    window.addEventListener('scroll', () => {
                        if (window.scrollY > 200) backToTopBtn.classList.add('visible'); else backToTopBtn.classList.remove('visible');
                        if (window.scrollY > 50) siteHeader.classList.add('scrolled'); else siteHeader.classList.remove('scrolled');
                    });
                    themeToggle.addEventListener('click', () => applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));
                    backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

                    if(customization?.customJS) { const customScript = document.createElement('script'); customScript.innerHTML = customization.customJS; document.body.appendChild(customScript); }
                    mainContainer.style.opacity = 1;
                } catch (error) {
                    mainContainer.innerHTML = `<div class="post-full" style="text-align:center;"><h1>博客加载失败</h1><p>${error.message}</p></div>`;
                    mainContainer.style.opacity = 1;
                }
            };
            main();
        });
    </script>
</body>
</html>