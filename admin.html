<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peony King - 管理中心</title>
    <style>
        :root {
            --primary: #6366f1; --primary-hover: #4f46e5; --danger: #ef4444; --danger-hover: #dc2626; --success: #22c55e;
            --bg-main: #f3f4f6; --bg-content: #ffffff; --text-main: #111827; --text-secondary: #6b7280; 
            --border: #e5e7eb; --sidebar-width: 220px; --header-height: 60px;
        }
        body.dark {
            --primary: #818cf8; --primary-hover: #6366f1; --bg-main: #111827; --bg-content: #1f2937;
            --text-main: #f9fafb; --text-secondary: #9ca3af; --border: #374151;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background-color: var(--bg-main); color: var(--text-main); transition: background-color .3s, color .3s; font-size: 15px; line-height: 1.6; overflow-x: hidden; }
        .admin-panel, .sidebar, .main-content { transition: opacity .3s, visibility .3s; }
        .hidden-until-login { opacity: 0; visibility: hidden; }
        .login-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; visibility: hidden; transition: all .3s; }
        .login-modal-overlay.open { opacity: 1; visibility: visible; }
        .login-modal-box { background-color: var(--bg-content); border-radius: 12px; padding: 32px; width: 100%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .login-step { display: none; } .login-step.active { display: block; }
        #login-status { text-align: center; margin-top: 16px; color: var(--text-secondary); font-size: 14px; min-height: 20px; }
        .admin-panel { display: flex; }
        .sidebar { width: var(--sidebar-width); height: 100vh; background-color: var(--bg-content); position: fixed; top: 0; left: 0; transform: translateX(-100%); transition: transform .3s ease, background-color .3s, opacity .3s, visibility .3s; z-index: 1000; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .sidebar.open { transform: translateX(0); }
        .main-content { width: 100%; margin-left: 0; padding-top: var(--header-height); transition: margin-left .3s ease, opacity .3s, visibility .3s; }
        @media (min-width: 768px) { .sidebar { transform: translateX(0); } .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); } }
        .header { height: var(--header-height); background-color: var(--bg-content); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: fixed; top: 0; width: 100%; z-index: 900; transition: background-color .3s, border-color .3s; }
        .menu-toggle { display: block; cursor: pointer; } .menu-toggle .icon { stroke: var(--text-secondary); }
        @media (min-width: 768px) { .menu-toggle { display: none; } .header { width: calc(100% - var(--sidebar-width)); left: var(--sidebar-width); } }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .sidebar-header { padding: 18px 24px; font-size: 1.25rem; font-weight: bold; white-space: nowrap; }
        .sidebar-nav { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .nav-item a { display: flex; align-items: center; padding: 11px 20px; border-radius: 8px; color: var(--text-secondary); font-weight: 500; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-item a:hover { background-color: var(--primary); color: white; }
        .nav-item a.active { background-color: var(--primary); color: white; font-weight: 600; }
        .nav-item a svg { margin-right: 15px; width: 20px; height: 20px; stroke-width: 2; flex-shrink: 0; }
        .content-wrapper { padding: 20px; }
        .page-header { margin-bottom: 20px; } .page-title { font-size: 1.6rem; font-weight: 700; } .page-subtitle { font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; }
        .content-view { display: none; } .content-view.active { display: block; animation: fadeIn .3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background-color: var(--bg-content); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 20px; }
        .card-title { font-size: 1.1rem; font-weight: 600; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn:disabled { background-color: var(--border); color: var(--text-secondary); cursor: not-allowed; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-danger { background-color: var(--danger); color: white; } .btn-danger:hover { background-color: var(--danger-hover); }
        .form-group { margin-bottom: 16px; } .form-label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .form-control { width: 100%; padding: 10px 14px; background-color: var(--bg-main); border: 1px solid var(--border); border-radius: 8px; color: var(--text-main); font-size: 0.95rem; transition: all .2s; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); }
        .form-hint { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; }
        .table-responsive { width: 100%; overflow-x: auto; } .table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        .table th, .table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        .table th { font-weight: 600; color: var(--text-secondary); font-size: 13px; text-transform: uppercase; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); } .empty-state svg { width: 48px; height: 48px; margin: 0 auto 16px; }
        .action-btn { background: none; border: none; padding: 6px; border-radius: 50%; cursor: pointer; transition: background-color .2s; width: auto; }
        .action-btn:hover { background-color: var(--border); } .action-btn svg { width: 18px; height: 18px; stroke: var(--text-secondary); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1100; display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; visibility: hidden; transition: all .3s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-box { background-color: var(--bg-content); border-radius: 12px; padding: 24px; width: 100%; max-width: 450px; }
        .modal-header { font-size: 1.2rem; font-weight: 600; margin-bottom: 12px; } .modal-body { color: var(--text-secondary); margin-bottom: 24px; } .modal-footer { display: flex; justify-content: flex-end; gap: 12px; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; } @media (min-width: 768px) { #overlay { display: none !important; } }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--bg-content); color: var(--text-main); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; transform: translateX(120%); animation: slideIn .3s ease forwards; }
        .toast.success { border-left: 4px solid var(--success); } .toast.danger { border-left: 4px solid var(--danger); }
        @keyframes slideIn { to { transform: translateX(0); } }
    </style>
</head>
<body class="dark">
    <div id="toast-container" class="toast-container"></div>

    <div id="login-modal" class="login-modal-overlay open">
        <div class="login-modal-box">
            <div id="step-token-input" class="login-step active">
                <h2 class="card-title" style="text-align: center; margin-bottom: 24px;">登录到 Peony King CMS</h2>
                <div class="form-group">
                    <label for="github-token" class="form-label">GitHub Personal Access Token (PAT)</label>
                    <input type="password" id="github-token" class="form-control" placeholder="粘贴您的Token...">
                    <p class="form-hint">需要 'repo' 范围权限。令牌仅保存在您的浏览器中。</p>
                </div>
                <button id="connect-github-btn" class="btn btn-primary">连接 GitHub</button>
            </div>
            <div id="step-repo-select" class="login-step">
                <h2 class="card-title" style="text-align: center; margin-bottom: 24px;" id="welcome-user"></h2>
                <div class="form-group">
                    <label for="repo-select" class="form-label">选择一个仓库进行管理</label>
                    <select id="repo-select" class="form-control"></select>
                </div>
                <button id="load-repo-btn" class="btn btn-primary">加载网站数据</button>
            </div>
            <div id="login-status"></div>
        </div>
    </div>

    <div class="admin-panel hidden-until-login">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">Peony King</div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item"><a href="#" class="nav-link active" data-view="dashboard"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>仪表盘</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-view="articles"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>文章管理</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-view="wallpapers"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>壁纸管理</a></li>
                </ul>
            </nav>
        </aside>
        
        <div class="main-content" id="main-content">
            <header class="header">
                <div class="menu-toggle" id="menu-toggle"><svg class="icon" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="save-to-github-btn" style="width: auto;" disabled>保存并同步到GitHub</button>
                    <button class="btn btn-secondary" id="logout-btn" style="width: auto;">登出</button>
                    <label class="switch" title="切换主题"><input type="checkbox" id="theme-toggle" checked><span class="slider"></span></label>
                </div>
            </header>

            <main class="content-wrapper">
                <div id="view-dashboard" class="content-view active">
                    <div class="page-header"><h1 class="page-title">仪表盘</h1><p class="page-subtitle" id="dashboard-subtitle"></p></div>
                    <div class="card"><div class="card-header"><h2 class="card-title">网站概览</h2></div><div class="card-body" id="dashboard-stats"></div></div>
                </div>

                <div id="view-articles" class="content-view">
                    <div class="page-header"><h1 class="page-title">文章管理</h1></div>
                    <div class="card"><div class="card-header"><h2 class="card-title">文章列表</h2><button class="btn btn-primary" id="new-article-btn" style="width:auto;">新建文章</button></div><div class="table-responsive"><table class="table"><thead id="articles-table-head"></thead><tbody id="articles-table-body"></tbody></table></div></div>
                </div>

                <div id="view-wallpapers" class="content-view">
                    <div class="page-header"><h1 class="page-title">壁纸管理</h1></div>
                    <div class="card"><div class="card-header"><h2 class="card-title">壁纸合集列表</h2><button class="btn btn-primary" id="new-wallpaper-btn" style="width:auto;">新建壁纸合集</button></div><div class="table-responsive"><table class="table"><thead id="wallpapers-table-head"></thead><tbody id="wallpapers-table-body"></tbody></table></div></div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="modal-overlay" id="edit-modal"><div class="modal-box"><div class="modal-header" id="edit-modal-title"></div><div class="modal-body" id="edit-modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" id="edit-modal-cancel" style="width:auto;">取消</button><button type="submit" class="btn btn-primary" id="edit-modal-save" style="width:auto;">保存</button></div></div></div>
    <div class="modal-overlay" id="delete-modal"><div class="modal-box"><div class="modal-header">确认操作</div><div class="modal-body">您确定要删除这个项目吗？此操作不可恢复。</div><div class="modal-footer"><button class="btn btn-secondary" data-modal-close style="width:auto;">取消</button><button class="btn btn-danger" id="confirm-delete" style="width:auto;">确认删除</button></div></div></div>
    <div id="overlay"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        let db = { articles: [], wallpapers: [] };
        let githubConfig = { token: null, owner: null, repo: null };
        let indexFileContent = '';
        let indexFileSha = '';
        let state = { editingType: null, editingId: null };
        
        const loginModal = $('#login-modal');
        const adminPanel = $('.admin-panel');
        const sidebar = $('#sidebar');
        const mainContent = $('#main-content');
        const deleteModal = $('#delete-modal');
        const editModal = $('#edit-modal');
        const menuToggle = $('#menu-toggle');
        const themeToggle = $('#theme-toggle');
        const overlay = $('#overlay');

        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            $('#toast-container').appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        };

        const setLoginStatus = (message, isError = false) => {
            const statusEl = $('#login-status');
            statusEl.textContent = message;
            statusEl.style.color = isError ? 'var(--danger)' : 'var(--text-secondary)';
        };

        const handleApiRequest = async (url, options = {}) => {
            options.headers = { ...options.headers, 'Authorization': `token ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json' };
            const response = await fetch(url, options);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || `API 请求失败: ${response.status}`);
            }
            if (response.status === 204) return null; // No Content
            return response.json();
        };
        
        const connectToGitHub = async () => {
            const token = $('#github-token').value.trim();
            if (!token) {
                setLoginStatus('Token 不能为空。', true);
                return;
            }
            githubConfig.token = token;
            setLoginStatus('正在验证身份...');
            
            try {
                const userData = await handleApiRequest('https://api.github.com/user');
                githubConfig.owner = userData.login;

                setLoginStatus('正在获取仓库列表...');
                const reposData = await handleApiRequest(`https://api.github.com/users/${githubConfig.owner}/repos?per_page=100&sort=pushed`);
                
                const repoSelect = $('#repo-select');
                repoSelect.innerHTML = reposData.map(repo => `<option value="${repo.name}">${repo.name}</option>`).join('');

                $('#welcome-user').textContent = `欢迎, ${githubConfig.owner}`;
                $('#step-token-input').classList.remove('active');
                $('#step-repo-select').classList.add('active');
                setLoginStatus('');
            } catch (error) {
                setLoginStatus(`连接失败: ${error.message}`, true);
                githubConfig.token = null;
            }
        };

        const loadRepoData = async () => {
            githubConfig.repo = $('#repo-select').value;
            if (!githubConfig.repo) return;
            setLoginStatus(`正在从 ${githubConfig.repo} 加载 index.html...`);

            try {
                const fileData = await handleApiRequest(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/index.html`);
                indexFileContent = atob(fileData.content);
                indexFileSha = fileData.sha;
const articlesMatch = indexFileContent.match(/const articlesData = ([\s\S]*?);/);
const wallpapersMatch = indexFileContent.match(/const wallpaperData = ([\s\S]*?);/);

                if (!articlesMatch || !wallpapersMatch) throw new Error('无法解析 index.html 中的数据结构。');
                
                db.articles = new Function(`return ${articlesMatch[1]}`)();
                db.wallpapers = new Function(`return ${wallpapersMatch[1]}`)();

                loginModal.classList.remove('open');
                adminPanel.classList.remove('hidden-until-login');
                
                localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                
                $('#save-to-github-btn').disabled = false;
                renderAll();
                showToast('网站数据加载成功！');

            } catch (error) {
                setLoginStatus(`加载失败: ${error.message}`, true);
            }
        };

        const saveToGitHub = async () => {
            const btn = $('#save-to-github-btn');
            btn.textContent = '保存中...';
            btn.disabled = true;

            try {
                const newArticlesString = `const articlesData = ${JSON.stringify(db.articles, null, 4)}`;
                const newWallpapersString = `const wallpaperData = ${JSON.stringify(db.wallpapers, null, 4)}`;
                
                let updatedContent = indexFileContent.replace(/const articlesData = (\[[\s\S]*?\])/, newArticlesString);
                updatedContent = updatedContent.replace(/const wallpaperData = (\[[\s\S]*?\])/, newWallpapersString);

                const url = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/index.html`;
                const options = {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `CMS: 内容更新于 ${new Date().toISOString()}`,
                        content: btoa(updatedContent),
                        sha: indexFileSha
                    })
                };

                const data = await handleApiRequest(url, options);
                indexFileSha = data.content.sha;
                indexFileContent = updatedContent;
                showToast('成功保存并同步到 GitHub!');
            } catch (error) {
                showToast(`保存失败: ${error.message}`, 'danger');
            } finally {
                btn.textContent = '保存并同步到GitHub';
                btn.disabled = false;
            }
        };

        const logout = () => {
            localStorage.removeItem('githubConfig');
            location.reload();
        };

        const renderAll = () => {
            renderTable('articles');
            renderTable('wallpapers');
            renderDashboard();
        };

        const renderDashboard = () => {
            $('#dashboard-subtitle').textContent = `当前管理仓库: ${githubConfig.owner}/${githubConfig.repo}`;
            $('#dashboard-stats').innerHTML = `<p>文章总数: ${db.articles.length}</p><p>壁纸合集数: ${db.wallpapers.length}</p>`;
        };

        const createActionButtons = (type, id) => `<td style="text-align:right;"><div style="display:flex; justify-content:flex-end; gap: 8px;"><button class="action-btn edit-btn" data-type="${type}" data-id="${id}" title="编辑"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><button class="action-btn delete-btn" data-type="${type}" data-id="${id}" title="删除"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></td>`;

        const renderTable = (type) => {
            const headers = type === 'articles' ? ['ID', '标题', '图片URL', ''] : ['ID', '标题', '缩略图URL', '图片数', ''];
            const tableHead = $(`#${type}-table-head`), tableBody = $(`#${type}-table-body`);
            tableHead.innerHTML = `<tr>${headers.map(h => `<th ${h===''?'style="text-align:right"':''}>${h}</th>`).join('')}</tr>`;
            const data = db[type];
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${headers.length}"><div class="empty-state"><p>暂无数据，请先新建。</p></div></td></tr>`;
                return;
            }
            tableBody.innerHTML = data.map(item => {
                let rowData = type === 'articles'
                    ? [item.id, item.title, item.img]
                    : [item.id, item.title, item.thumb, item.images.length];
                return `<tr>${rowData.map(td => `<td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${td}">${td}</td>`).join('')}${createActionButtons(type, item.id)}</tr>`;
            }).join('');
        };

        const openEditModal = (type, id = null) => {
            state.editingType = type;
            state.editingId = id;
            const isArticle = type === 'articles';
            const item = id ? db[type].find(i => i.id == id) : null;
            
            $('#edit-modal-title').textContent = `${id ? '编辑' : '新建'}${isArticle ? '文章' : '壁纸合集'}`;
            
            let formHtml = `<div class="form-group"><label class="form-label">ID</label><input type="text" id="edit-id" class="form-control" ${id ? 'disabled' : ''} value="${item?.id ?? ''}"></div>`;
            formHtml += `<div class="form-group"><label class="form-label">标题</label><input type="text" id="edit-title" class="form-control" value="${item?.title ?? ''}"></div>`;
            
            if (isArticle) {
                formHtml += `<div class="form-group"><label class="form-label">图片URL</label><input type="url" id="edit-img" class="form-control" value="${item?.img ?? ''}"></div>`;
            } else {
                formHtml += `<div class="form-group"><label class="form-label">缩略图URL</label><input type="url" id="edit-thumb" class="form-control" value="${item?.thumb ?? ''}"></div>`;
                formHtml += `<div class="form-group"><label class="form-label">图片列表 (每行一个URL)</label><textarea id="edit-images" class="form-control" rows="5">${item?.images.join('\n') ?? ''}</textarea></div>`;
            }
            $('#edit-modal-body').innerHTML = formHtml;
            editModal.classList.add('open');
        };

        const saveEdit = () => {
            const { editingType, editingId } = state;
            const isArticle = editingType === 'articles';
            const idInput = $('#edit-id').value.trim();
            const idValue = isArticle ? parseInt(idInput) : idInput;
            const item = editingId ? db[editingType].find(i => i.id == editingId) : null;

            if (!idValue && idValue !== 0) { showToast('ID不能为空', 'danger'); return; }

            const newItemData = {
                id: idValue,
                title: $('#edit-title').value,
                type: isArticle ? 'latest' : 'wallpaper',
            };

            if(isArticle) {
                newItemData.img = $('#edit-img').value;
            } else {
                newItemData.thumb = $('#edit-thumb').value;
                newItemData.images = $('#edit-images').value.split('\n').filter(url => url.trim() !== '');
                newItemData.date = item?.date || '2025-01-01';
                newItemData.views = item?.views || 100;
            }

            if(editingId) {
                const index = db[editingType].findIndex(i => i.id == editingId);
                db[editingType][index] = newItemData;
            } else {
                if (db[editingType].some(i => i.id == newItemData.id)) {
                    showToast('该ID已存在，请使用唯一的ID', 'danger'); return;
                }
                db[editingType].push(newItemData);
            }
            renderTable(editingType);
            renderDashboard();
            editModal.classList.remove('open');
            showToast('内容已在本地保存。点击右上角同步到GitHub。');
        };

        const showView = (viewId) => {
            $$('.content-view').forEach(v => v.classList.remove('active'));
            $(`#view-${viewId}`).classList.add('active');
            $$('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.view === viewId));
            if (window.innerWidth < 768) { sidebar.classList.remove('open'); overlay.style.display = 'none'; }
        };

        const init = () => {
            $('#connect-github-btn').addEventListener('click', connectToGitHub);
            $('#load-repo-btn').addEventListener('click', loadRepoData);
            $('#save-to-github-btn').addEventListener('click', saveToGitHub);
            $('#logout-btn').addEventListener('click', logout);
            
            menuToggle.addEventListener('click', () => { sidebar.classList.toggle('open'); overlay.style.display = 'block'; });
            overlay.addEventListener('click', () => { sidebar.classList.remove('open'); overlay.style.display = 'none'; });
            themeToggle.addEventListener('change', () => document.body.classList.toggle('dark', !themeToggle.checked));
            
            sidebar.addEventListener('click', e => {
                const navLink = e.target.closest('.nav-link');
                if (navLink) { e.preventDefault(); showView(navLink.dataset.view); }
            });

            $('#new-article-btn').addEventListener('click', () => openEditModal('articles'));
            $('#new-wallpaper-btn').addEventListener('click', () => openEditModal('wallpapers'));
            
            mainContent.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if(editBtn) openEditModal(editBtn.dataset.type, editBtn.dataset.id);
                if(deleteBtn) {
                    deleteModal.classList.add('open');
                    deleteModal.dataset.type = deleteBtn.dataset.type;
                    deleteModal.dataset.id = deleteBtn.dataset.id;
                }
            });

            $('#edit-modal-save').addEventListener('click', saveEdit);
            $('#edit-modal-cancel').addEventListener('click', () => editModal.classList.remove('open'));

            deleteModal.addEventListener('click', e => {
                const target = e.target.closest('[data-modal-close], #confirm-delete');
                if (!target) return;
                if(target.id === 'confirm-delete') {
                    const { type, id } = deleteModal.dataset; 
                    db[type] = db[type].filter(item => item.id != id);
                    renderTable(type);
                    renderDashboard();
                    showToast('项目已在本地删除。点击右上角同步到GitHub。');
                }
                deleteModal.classList.remove('open');
            });
            
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                githubConfig = JSON.parse(savedConfig);
                $('#github-token').value = githubConfig.token;
                connectToGitHub().then(() => {
                    const repoSelect = $('#repo-select');
                    repoSelect.value = githubConfig.repo;
                    loadRepoData();
                });
            }
        };

        init();
    });
    </script>
</body>
</html>